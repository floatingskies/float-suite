<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thesis.web - Academic Suite</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#FFDE59">
    <meta name="description" content="ABNT, APA, MLA Academic Editor">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* Palette */
            --c-bg: #e0e0e0;
            --c-panel: #ffffff;
            --c-border: #000000;
            --c-text: #000000;
            
            /* Accents */
            --c-primary: #FFDE59;   /* Acid Yellow */
            --c-secondary: #FF90E8; /* Hot Pink */
            --c-accent: #23C9FF;    /* Cyan */
            --c-success: #00E096;   /* Green */
            --c-danger: #FF5C5C;    /* Red */
            
            /* Structural */
            --border-width: 3px;
            --shadow-hard: 4px 4px 0px var(--c-border);
            --shadow-active: 2px 2px 0px var(--c-border);
            
            --font-ui: 'Courier New', Courier, monospace;
            
            /* Document Dimensions */
            --page-width: 210mm;
            --page-height: 297mm;
            --page-gap: 20px;
        }

        /* Dark Mode Override */
        [data-theme="dark"] {
            --c-bg: #121212;
            --c-panel: #1e1e1e;
            --c-text: #ffffff;
            --c-border: #ffffff;
            --c-primary: #bfa300;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s;
        }

        .btn {
            background: var(--c-panel);
            border: var(--border-width) solid var(--c-border);
            box-shadow: 2px 2px 0px var(--c-border);
            padding: 8px 12px;
            font-family: var(--font-ui);
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.1s;
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px;
            font-size: 11px;
            color: #000;
            user-select: none;
        }
        .btn:hover { 
            background: var(--c-primary); 
            transform: translate(-1px, -1px); 
            box-shadow: 3px 3px 0px var(--c-border); 
        }
        .btn:active, .btn.active { 
            background: var(--c-secondary); 
            transform: translate(2px, 2px); 
            box-shadow: 0px 0px 0px var(--c-border); 
        }
        
        .btn-primary { background: var(--c-primary); }
        .btn-secondary { background: var(--c-secondary); }
        .btn-accent { background: var(--c-accent); }
        .btn-danger { background: var(--c-danger); color: #fff; }
        
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; }
        .btn-full { width: 100%; }

        .panel {
            background: var(--c-panel);
            border: var(--border-width) solid var(--c-border);
            z-index: 10;
        }

        /* Form Elements */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 8px; border: 2px solid #000; font-family: var(--font-ui);
            background: var(--c-bg); color: var(--c-text);
            font-size: 13px; transition: background 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus { background: #fff; }

        header {
            height: 56px;
            border-bottom: var(--border-width) solid var(--c-border);
            background: var(--c-primary);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px;
            z-index: 20;
            flex-shrink: 0;
        }
        .logo { font-size: 18px; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 8px;}

        #app-container {
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            position: relative;
        }

        /* SIDEBAR */
        #sidebar {
            width: 300px;
            border-right: var(--border-width) solid var(--c-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            background: var(--c-panel);
            transition: transform 0.3s ease;
        }

        .sidebar-section { padding: 15px; border-bottom: 2px solid var(--c-border); }
        .sidebar-title { font-weight: 900; margin-bottom: 10px; display: block; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid var(--c-primary); padding-bottom: 4px; display: inline-block;}

        .format-option {
            display: flex; align-items: center; width: 100%; text-align: left;
            margin-bottom: 8px; padding: 8px;
            border: 2px solid var(--c-border);
            cursor: pointer;
            background: #fff;
            font-weight: bold; font-size: 12px;
            transition: 0.1s;
        }
        .format-option:hover { background: #eee; transform: translateX(2px); }
        .format-option.active { background: var(--c-accent); color: #fff; border-color: #000; box-shadow: 2px 2px 0 #000; }

        /* Toolbar Grid */
        .toolbar-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 5px;
        }
        
        .toolbar-select {
            width: 100%; padding: 5px; border: 2px solid #000; font-family: var(--font-ui);
            font-size: 11px; margin-top: 5px; background: #fff;
        }

        /* Document List Styles */
        #doc-list {
            list-style: none;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #000;
            padding: 0;
        }
        .doc-item {
            padding: 8px;
            border-bottom: 1px solid #000;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .doc-item:hover { background: #f0f0f0; }
        .doc-item.active { background: var(--c-primary); font-weight: bold; }
        .doc-item .doc-name { 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            max-width: 180px; flex: 1; 
            pointer-events: none; 
        }
        .doc-item .doc-actions { display: flex; gap: 5px; margin-left: 5px; }
        .doc-btn-mini {
            background: transparent; border: none; cursor: pointer; color: #666; padding: 4px;
            transition: color 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .doc-btn-mini:hover { color: var(--c-danger); transform: scale(1.1); }

        /* WORKSPACE (The Gray Area) */
        #workspace {
            flex: 1;
            background-color: #bbb;
            background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: var(--c-bg);
            overflow: auto;
            padding: 40px 20px;
            display: flex; 
            flex-direction: column;
            align-items: center;
        }

        /* THE A4 PAPER STACK CONTAINER */
        #paper {
            width: var(--page-width); 
            background: transparent; 
            box-shadow: none;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 40px;
        }

        /* EDITOR AREA - Multi-Page Logic */
        #editor-area {
            flex: 1;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 0; 
            min-height: calc(var(--page-height) * 1);
            width: 100%;
            background-color: #fff;
            background-image: 
                linear-gradient(to bottom, 
                    #fff 0px, 
                    #fff calc(var(--page-height) - 3px), 
                    #000 calc(var(--page-height) - 3px), 
                    #000 var(--page-height), 
                    transparent var(--page-height), 
                    transparent calc(var(--page-height) + var(--page-gap))
                );
            background-size: 100% calc(var(--page-height) + var(--page-gap));
            background-repeat: repeat-y;
            background-attachment: local;
            color: #000;
            position: relative;
        }

        /* Cover Page */
        #cover-page {
            height: var(--page-height); 
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-bottom: 0;
            background-color: #fff;
            width: var(--page-width);
            border: 3px solid #000;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            margin-bottom: var(--page-gap);
            padding: 0; 
        }

        /* FOOTER */
        footer {
            height: 30px; background: var(--c-panel); border-top: var(--border-width) solid var(--c-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 11px;
            font-weight: bold; flex-shrink: 0;
        }

        /* =========================================
           4. ACADEMIC STYLES
           ========================================= */
        
        #editor-area p, #editor-area li {
            orphans: 3;
            widows: 3;
        }
        
        @media print {
            #editor-area p, #editor-area h1, #editor-area h2, #editor-area li {
                break-inside: avoid;
            }
        }

        /* ABNT */
        .style-abnt #editor-area, .style-abnt #cover-page {
            padding: 3cm 2cm 2cm 3cm;
        }
        .style-abnt #editor-area, .style-abnt p, .style-abnt li {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.5;
            text-align: justify;
            margin-bottom: 0; 
            text-indent: 1.25cm;
        }
        .style-abnt p:first-of-type { text-indent: 1.25cm; }
        .style-abnt h1 { font-family: Arial, sans-serif; font-size: 14pt; font-weight: bold; text-align: center; margin: 20px 0 10px 0; text-indent: 0; }
        .style-abnt h2 { font-family: Arial, sans-serif; font-size: 12pt; font-weight: bold; text-align: left; margin: 10px 0; text-indent: 0; }
        .style-abnt #cover-page h1 { font-size: 16pt; margin-bottom: 40px; font-weight: bold; text-align: center; }
        .style-abnt #cover-page h2 { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin-bottom: 120px; text-align: center; }

        /* APA */
        .style-apa #editor-area, .style-apa #cover-page { padding: 1in; }
        .style-apa #editor-area, .style-apa p, .style-apa li {
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 2; 
            text-align: left;
        }
        .style-apa p { margin-bottom: 0; text-indent: 0.5in; }
        .style-apa h1 { font-size: 12pt; font-weight: bold; text-align: center; margin-bottom: 10px; text-indent: 0; }
        .style-apa #cover-page h2 { font-size: 14pt; margin-bottom: 40px; text-align: center;}
        
        /* MLA */
        .style-mla #editor-area, .style-mla #cover-page { padding: 1in; }
        .style-mla #editor-area, .style-mla p {
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1;
            text-align: left;
            margin-bottom: 10px;
        }
        .style-mla h1 { font-size: 14pt; font-weight: bold; text-align: left; margin-bottom: 5px; }

        /* =========================================
           5. MODALS & UTILS
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: var(--c-panel); border: var(--border-width) solid var(--c-border);
            width: 90%; max-width: 500px;
            padding: 20px;
            box-shadow: 10px 10px 0px #000;
            display: flex; flex-direction: column; gap: 10px;
            animation: slideIn 0.2s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes slideIn { from {transform: translateY(20px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .modal-header { font-size: 18px; font-weight: 900; margin-bottom: 10px; border-bottom: 3px solid #000; padding-bottom: 10px;}
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        .toast {
            position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: var(--c-primary); color: #000;
            padding: 10px 20px; border: 2px solid #000;
            box-shadow: 4px 4px 0px #000;
            font-weight: bold; z-index: 2000;
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        .toast.hidden { display: none; }
        @keyframes popUp { from {transform: translate(-50%, 100%); opacity: 0;} to {transform: translate(-50%, 0); opacity: 1;} }

        /* ZEN MODE */
        body.focus-mode #sidebar, body.focus-mode header, body.focus-mode footer, 
        body.focus-mode .modal-overlay, body.focus-mode .toast, 
        body.focus-mode #zen-toggle-wrapper { display: none !important; }
        
        body.focus-mode #workspace { padding: 0; background: #888; }
        body.focus-mode #paper { box-shadow: none; margin: 40px auto; width: 210mm; }
        
        #zen-toggle-wrapper { position: fixed; top: 70px; right: 20px; z-index: 100; display: none; }
        body:not(.focus-mode) #zen-toggle-wrapper { display: block; }

        /* EXIT ZEN BUTTON */
        #zen-exit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
            background: var(--c-danger);
            color: #fff;
            border: 3px solid #000;
            padding: 10px 20px;
            font-family: var(--font-ui);
            font-weight: bold;
            box-shadow: 4px 4px 0px #000;
            cursor: pointer;
            text-transform: uppercase;
        }
        #zen-exit-btn:hover {
            background: #ff3333;
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px #000;
        }
        body.focus-mode #zen-exit-btn { display: block; }

        /* =========================================
           6. PRINT ENGINE
           ========================================= */
        @media print {
            body { background: white; height: auto; overflow: visible; display: block; }
            header, #sidebar, footer, .modal-overlay, .toast, .toolbar-grid, #zen-toggle-wrapper, #mobile-menu-btn, #zen-exit-btn { display: none !important; }
            #workspace { padding: 0; background: white; display: block; overflow: visible; }
            #paper { box-shadow: none; margin: 0; width: 100%; padding: 0; min-height: auto; border: none; }
            #editor-area { background-image: none !important; background: white !important; width: 100%; }
            @page { size: A4; margin: 0; }
            #cover-page { page-break-after: always; border: none; box-shadow: none; margin: 0; min-height: auto; height: auto; padding-top: 3cm !important; }
            #editor-area::after { content: ""; display: block; height: 20px; }
        }

        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; z-index: 50; transform: translateX(-100%); background: var(--c-panel); box-shadow: 5px 0 0 #000;}
            #sidebar.mobile-active { transform: translateX(0); }
            #mobile-menu-btn { display: block !important; }
            #zen-toggle-wrapper { display: none !important; }
            body.focus-mode #zen-exit-btn { top: auto; bottom: 20px; right: 20px; }
        }
        #mobile-menu-btn { display: none; position: absolute; top: 10px; left: 10px; z-index: 60; }
    </style>
</head>
<body>

    <!-- ZEN EXIT BUTTON -->
    <button id="zen-exit-btn" onclick="App.toggleZen()">
        <i class="fas fa-times"></i> Exit Zen Mode
    </button>

    <!-- HEADER -->
    <header>
        <button class="btn btn-icon" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        <div class="logo"><i class="fas fa-graduation-cap"></i> THESIS.WEB <span style="font-size:10px; font-weight:normal; margin-left:5px; background:#000; color:#fff; padding:2px 4px;">INFDEV</span></div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-sm" id="btn-guide" title="Open Guide"><i class="fas fa-book"></i> Guide</button>
            <button class="btn btn-sm btn-accent" id="btn-ref" title="Insert Reference"><i class="fas fa-book-open"></i> Refs</button>
            <button class="btn btn-sm" id="btn-zen" title="Focus Mode"><i class="fas fa-expand"></i></button>
        </div>
    </header>

    <div id="app-container">
        
        <!-- SIDEBAR -->
        <aside class="panel" id="sidebar">
            
            <!-- 1. DOCUMENTS MANAGER -->
            <div class="sidebar-section">
                <span class="sidebar-title"><i class="fas fa-folder-open"></i> My Documents</span>
                <button class="btn btn-sm btn-primary btn-full" onclick="App.openSaveModal()">
                    <i class="fas fa-plus"></i> Save As New...
                </button>
                <button class="btn btn-sm btn-secondary btn-full" style="margin-top:5px;" onclick="App.updateCurrentDoc()" id="btn-update-doc">
                    <i class="fas fa-save"></i> Update Current
                </button>
                <ul id="doc-list">
                    <!-- Files injected here via JS -->
                </ul>
            </div>

            <!-- Standard Selection -->
            <div class="sidebar-section">
                <span class="sidebar-title">2. Standard</span>
                <button class="format-option active" data-style="style-abnt" onclick="App.setStandard('abnt')">
                    <i class="fas fa-flag"></i> ABNT (NBR 14724)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Arial 12pt, 1.5</div>
                </button>
                <button class="format-option" data-style="style-apa" onclick="App.setStandard('apa')">
                    <i class="fas fa-landmark"></i> APA (7th Ed)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Times, Double</div>
                </button>
                <button class="format-option" data-style="style-mla" onclick="App.setStandard('mla')">
                    <i class="fas fa-university"></i> MLA (9th Ed)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Times, Single</div>
                </button>
            </div>

            <!-- Formatting Tools -->
            <div class="sidebar-section">
                <span class="sidebar-title">3. Text & Titles</span>
                
                <!-- Basic Style -->
                <div class="toolbar-grid">
                    <button class="btn btn-sm" onclick="App.exec('bold')"><b>B</b></button>
                    <button class="btn btn-sm" onclick="App.exec('italic')"><i>I</i></button>
                    <button class="btn btn-sm" onclick="App.exec('underline')"><u>U</u></button>
                    <button class="btn btn-sm" onclick="App.exec('strikeThrough')"><s>S</s></button>
                </div>

                <!-- Headings & Size -->
                <div class="toolbar-grid" style="margin-top:5px; border-top:2px solid #000; padding-top:5px;">
                    <button class="btn btn-sm" onclick="App.formatBlock('H1')">H1</button>
                    <button class="btn btn-sm" onclick="App.formatBlock('H2')">H2</button>
                    <button class="btn btn-sm" onclick="App.formatBlock('P')">P</button>
                    <button class="btn btn-sm" onclick="App.exec('removeFormat')">Clr</button>
                </div>
                
                <select id="font-size-select" class="toolbar-select" onchange="App.exec('fontSize', this.value)">
                    <option value="3">Font Size: Normal</option>
                    <option value="1">Font Size: Tiny</option>
                    <option value="2">Font Size: Small</option>
                    <option value="3">Font Size: Normal</option>
                    <option value="4">Font Size: Large</option>
                    <option value="5">Font Size: Huge</option>
                    <option value="6">Font Size: Massive</option>
                    <option value="7">Font Size: Giant</option>
                </select>

                <div style="margin-top:10px;">
                    <button class="btn btn-sm btn-full" onclick="App.exec('insertUnorderedList')"><i class="fas fa-list-ul"></i> Bullet List</button>
                    <button class="btn btn-sm btn-full" style="margin-top:5px;" onclick="App.exec('insertOrderedList')"><i class="fas fa-list-ol"></i> Numbered List</button>
                </div>
            </div>

            <!-- Page Tools -->
            <div class="sidebar-section">
                <span class="sidebar-title">4. Page Tools</span>
                <button class="btn btn-sm btn-secondary btn-full" id="btn-toggle-cover" onclick="App.toggleCover()">
                    <i class="fas fa-file"></i> <span id="cover-btn-text">Insert Cover Page</span>
                </button>
                <small style="display:block; margin:8px 0; color:#666; line-height:1.2;">Auto-formats cover for selected standard.</small>
                
                <button class="btn btn-sm btn-secondary btn-full" style="margin-bottom:8px;" onclick="App.insertStructure('abstract')">
                    <i class="fas fa-heading"></i> Insert Abstract
                </button>
                <button class="btn btn-sm btn-secondary btn-full" onclick="App.insertStructure('references')">
                    <i class="fas fa-book-open"></i> Insert Ref. Header
                </button>
                <button class="btn btn-sm btn-danger btn-full" style="margin-top:8px;" onclick="App.clearPaper()"><i class="fas fa-trash"></i> Clear Paper</button>
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main id="workspace">
            <div id="paper" class="style-abnt">
                <!-- Cover Page (Dynamic Content) -->
                <div id="cover-page">
                    <h2 contenteditable="true" id="cover-inst">INSTITUTION NAME</h2>
                    <h3 contenteditable="true" id="cover-author">Author Name</h3>
                    <h1 contenteditable="true" id="cover-title">Title of the Work</h1>
                    <div style="margin-top:100px; text-align:center; line-height:1.5; text-indent:0;">
                        <p contenteditable="true">City</p>
                        <p contenteditable="true">Year</p>
                    </div>
                </div>

                <!-- Main Text Editor -->
                <div id="editor-area" contenteditable="true" spellcheck="false">
                    <h1>Introduction</h1>
                    <p>Highlight text and use the sidebar buttons to change formatting (H1, H2, Font Size).</p>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                    <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- FOOTER -->
    <footer>
        <div id="status-doc">Doc: Unsaved Draft</div>
        <div id="status-stats">Words: 0 | Chars: 0</div>
        <div id="status-save"><i class="fas fa-check-circle" style="color:var(--c-success)"></i> Ready</div>
    </footer>

    <!-- FOCUS MODE TOGGLE -->
    <div id="zen-toggle-wrapper">
        <button class="btn btn-icon" onclick="App.toggleZen()">
            <i class="fas fa-compress"></i>
        </button>
    </div>

    <!-- SAVE AS MODAL -->
    <div class="modal-overlay hidden" id="save-modal">
        <div class="modal-content">
            <div class="modal-header">Save Document</div>
            <div class="form-group">
                <label>Document Name</label>
                <input type="text" id="new-doc-name" placeholder="e.g. Thesis Chapter 1">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('save-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.saveAsNew()">Save</button>
            </div>
        </div>
    </div>

    <!-- GUIDE MODAL -->
    <div class="modal-overlay hidden" id="guide-modal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-info-circle"></i> Quick Guide</div>
            <div style="font-size:12px; line-height:1.6; max-height:300px; overflow-y:auto;">
                <b>1. My Documents:</b> Click "Save As" to store your work. Click a file name to open it. Use the <b>Trash Icon</b> to delete.
                <br><br>
                <b>2. Text & Titles:</b> Select text to apply <b>H1</b> (Main Title), <b>H2</b> (Subtitle), or change <b>Font Size</b> manually.
                <br><br>
                <b>3. Auto-Formatting:</b> Paste (Ctrl+V) text, and it will automatically format to the selected standard (ABNT/APA).
                <br><br>
                <b>4. Zen Mode:</b> Click the Expand icon to hide all distractions. Click the red "Exit Zen Mode" button to return.
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-primary" onclick="App.closeModal('guide-modal')">Got it</button>
            </div>
        </div>
    </div>

    <!-- REFERENCE GENERATOR MODAL -->
    <div class="modal-overlay hidden" id="ref-modal">
        <div class="modal-content">
            <div class="modal-header">Reference Generator</div>
            <div class="form-group">
                <label>Format Standard</label>
                <select id="ref-std" onchange="App.updateRefPreview()">
                    <option value="abnt">ABNT (NBR 14724)</option>
                    <option value="apa">APA (7th Ed.)</option>
                    <option value="mla">MLA (9th Ed.)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Author (Surname, Name)</label>
                <input type="text" id="ref-author" placeholder="Silva, João" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="ref-title" placeholder="Book Title" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Year</label>
                <input type="number" id="ref-year" placeholder="2023" oninput="App.updateRefPreview()">
            </div>
            <div style="background:#eee; border:2px dashed #000; padding:10px; margin-bottom:10px; font-family:serif; font-size:12px;">
                <label style="font-family:var(--font-ui); font-size:10px; display:block; margin-bottom:4px;">PREVIEW:</label>
                <div id="ref-preview-output" style="color:#000;">...</div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('ref-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertReference()"><i class="fas fa-plus"></i> Insert Ref</button>
            </div>
        </div>
    </div>

    <!-- PRINT INSTRUCTION MODAL -->
    <div class="modal-overlay hidden" id="print-modal">
        <div class="modal-content" style="border-color: var(--c-accent);">
            <div class="modal-header"><i class="fas fa-exclamation-triangle"></i> Print Setup</div>
            <div style="font-size:13px; line-height:1.5;">
                <p>To get a professional PDF without browser junk (URLs, dates), please check these settings in the print dialog:</p>
                <ol style="margin-left:20px; margin-top:10px;">
                    <li><b>More settings</b> -> Uncheck <b>"Headers and footers"</b>.</li>
                    <li>Check <b>"Background graphics"</b> (if you want highlight colors).</li>
                    <li>Set margins to <b>"Default"</b> or <b>"None"</b>.</li>
                </ol>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('print-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="window.print()">Print Now</button>
            </div>
        </div>
    </div>

    <!-- CLEAR CONFIRM MODAL -->
    <div class="modal-overlay hidden" id="clear-modal">
        <div class="modal-content" style="border-color: var(--c-danger);">
            <div class="modal-header"><i class="fas fa-exclamation-circle"></i> Confirm Clear</div>
            <p>Are you sure? This will delete all your text and cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('clear-modal')">Cancel</button>
                <button class="btn btn-danger" onclick="App.confirmClear()">Yes, Delete All</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast hidden" id="toast-msg">Action Successful</div>

   <script>
    class ThesisApp {
        constructor() {
            this.paper = document.getElementById('paper');
            this.editor = document.getElementById('editor-area');
            this.currentStandard = 'abnt';
            this.documents = [];
            this.currentDocId = null;
            this.saveTimer = null;
        }

        init() {
            this.loadDocuments();
            this.bindEvents();
            this.updateStats();
            
            if (this.documents.length === 0) {
                this.openModal('guide-modal');
            } else {
                Utils.toast('System Ready');
            }
        }

        exec(command, value = null) {
            document.execCommand(command, false, value);
            this.editor.focus();
            this.triggerAutoSave();
        }

        // New Function for Headings/Titles
        formatBlock(tag) {
            // formatBlock changes the block element type (H1, H2, P, etc.)
            document.execCommand('formatBlock', false, `<${tag}>`);
            this.editor.focus();
            this.triggerAutoSave();
        }

        bindEvents() {
            this.editor.addEventListener('input', () => {
                this.updateStats();
                this.triggerAutoSave();
            });

            // === SMART AUTO-FORMAT PASTE ===
            this.editor.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                const paragraphs = text.split(/\r\n|\r|\n/).filter(line => line.trim() !== '');

                if (paragraphs.length === 0) return;

                const frag = document.createDocumentFragment();
                paragraphs.forEach((paraText) => {
                    const p = document.createElement('p');
                    p.textContent = paraText;
                    frag.appendChild(p);
                });

                const selection = window.getSelection();
                if (selection.rangeCount) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(frag);
                    range.setStartAfter(frag.lastChild);
                    range.setEndAfter(frag.lastChild);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                Utils.toast('Auto-formatted pasted text');
            });

            document.getElementById('btn-guide').onclick = () => this.openModal('guide-modal');
            document.getElementById('btn-ref').onclick = () => this.openRefModal();
            document.getElementById('btn-zen').onclick = () => this.toggleZen();
            
            document.getElementById('mobile-menu-btn').onclick = () => {
                document.getElementById('sidebar').classList.toggle('mobile-active');
            };

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if(e.target === overlay) this.closeModal(overlay.id);
                });
            });
        }

        // ==========================================
        // DOCUMENT MANAGEMENT SYSTEM
        // ==========================================

        loadDocuments() {
            const saved = localStorage.getItem('thesis_files');
            if (saved) {
                try {
                    this.documents = JSON.parse(saved);
                } catch(e) { this.documents = []; }
            }
            this.renderDocList();
        }

        saveToStorage() {
            localStorage.setItem('thesis_files', JSON.stringify(this.documents));
        }

        renderDocList() {
            const list = document.getElementById('doc-list');
            list.innerHTML = ''; 
            
            this.documents.forEach(doc => {
                const li = document.createElement('li');
                li.className = `doc-item ${this.currentDocId === doc.id ? 'active' : ''}`;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'doc-name';
                nameDiv.innerHTML = `<i class="fas fa-file-alt"></i> ${doc.name}`;
                nameDiv.onclick = () => this.loadDocument(doc.id);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'doc-actions';

                const delBtn = document.createElement('button');
                delBtn.className = 'doc-btn-mini';
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.title = "Delete Document";
                delBtn.onclick = (e) => {
                    e.stopPropagation(); 
                    e.preventDefault(); 
                    this.deleteDocument(doc.id);
                };

                actionsDiv.appendChild(delBtn);
                li.appendChild(nameDiv);
                li.appendChild(actionsDiv);
                
                list.appendChild(li);
            });
        }

        openSaveModal() {
            document.getElementById('new-doc-name').value = '';
            this.openModal('save-modal');
            setTimeout(() => document.getElementById('new-doc-name').focus(), 100);
        }

        saveAsNew() {
            const nameInput = document.getElementById('new-doc-name');
            const name = nameInput.value.trim() || 'Untitled Document';
            
            const newDoc = {
                id: Date.now(),
                name: name,
                content: this.paper.outerHTML,
                standard: this.currentStandard,
                timestamp: new Date().toISOString()
            };

            this.documents.unshift(newDoc); 
            this.currentDocId = newDoc.id;
            
            this.saveToStorage();
            this.renderDocList();
            this.closeModal('save-modal');
            this.updateStatusDoc(name);
            Utils.toast('Document Saved');
        }

        updateCurrentDoc() {
            if (!this.currentDocId) {
                this.openSaveModal();
                Utils.toast('No document selected. Saving as new...');
                return;
            }

            const docIndex = this.documents.findIndex(d => d.id === this.currentDocId);
            if (docIndex > -1) {
                this.documents[docIndex].content = this.paper.outerHTML;
                this.documents[docIndex].standard = this.currentStandard;
                this.documents[docIndex].timestamp = new Date().toISOString();
                this.saveToStorage();
                Utils.toast('Document Updated');
            }
        }

        loadDocument(id) {
            const doc = this.documents.find(d => d.id === id);
            if (!doc) return;

            const temp = document.createElement('div');
            temp.innerHTML = doc.content;
            const newPaper = temp.firstElementChild;

            if (newPaper && (newPaper.id === 'paper' || newPaper.id === 'paper-loaded')) {
                this.paper.parentNode.replaceChild(newPaper, this.paper);
                this.paper = newPaper;
                this.editor = document.getElementById('editor-area');
            }

            this.currentDocId = id;
            this.setStandard(doc.standard);
            
            this.renderDocList();
            this.updateStatusDoc(doc.name);
            this.updateStats();
            
            Utils.toast(`Loaded: ${doc.name}`);
            
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-active');
            }
        }

        deleteDocument(id) {
            if(confirm('Are you sure you want to delete this document?')) {
                this.documents = this.documents.filter(d => d.id !== id);
                if (this.currentDocId === id) {
                    this.currentDocId = null;
                    this.clearPaper(false);
                    this.updateStatusDoc('Unsaved Draft');
                }
                this.saveToStorage();
                this.renderDocList();
                Utils.toast('Document Deleted');
            }
        }

        triggerAutoSave() {
            const status = document.getElementById('status-save');
            if(!status) return;
            status.innerHTML = '<i class="fas fa-pen"></i> Typing...';
            
            if(this.saveTimer) clearTimeout(this.saveTimer);
            
            this.saveTimer = setTimeout(() => {
                if (this.currentDocId) {
                    this.updateCurrentDoc();
                }
                status.innerHTML = '<i class="fas fa-check-circle" style="color:var(--c-success)"></i> Saved';
            }, 2000);
        }

        updateStatusDoc(name) {
            document.getElementById('status-doc').innerText = `Doc: ${name}`;
        }

        // ==========================================
        // EDITOR LOGIC
        // ==========================================

        clearPaper(confirmAction = true) {
            if (confirmAction) {
                this.openModal('clear-modal');
            } else {
                this.editor.innerHTML = '<p>Start writing...</p>';
                const cover = document.getElementById('cover-page');
                if(cover) cover.style.display = 'none';
                this.updateStats();
            }
        }

        confirmClear() {
            this.clearPaper(false);
            this.closeModal('clear-modal');
            Utils.toast('Paper Cleared');
        }

        insertStructure(type) {
            if (!this.editor) return;
            const h2 = document.createElement('h2');
            let label = '';
            if (type === 'abstract') label = (this.currentStandard === 'abnt') ? 'RESUMO' : 'ABSTRACT';
            else if (type === 'references') label = (this.currentStandard === 'abnt') ? 'REFERÊNCIAS' : 'REFERENCES';

            h2.innerText = label;
            const p = document.createElement('p');
            p.innerHTML = '<br>';

            try {
                if (type === 'abstract') {
                    this.editor.prepend(h2);
                    this.editor.prepend(p);
                } else {
                    this.editor.appendChild(h2);
                    this.editor.appendChild(p);
                }
                setTimeout(() => {
                    this.editor.focus();
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(p);
                    range.collapse(false); 
                    sel.removeAllRanges();
                    sel.addRange(range);
                }, 10);
                this.triggerAutoSave();
                Utils.toast(`${label} Section Added`);
            } catch (e) { console.error(e); }
        }

        openRefModal() {
            document.getElementById('ref-std').value = this.currentStandard;
            ['ref-author','ref-title','ref-year'].forEach(id => document.getElementById(id).value = '');
            this.updateRefPreview();
            this.openModal('ref-modal');
        }

        updateRefPreview() {
            const std = document.getElementById('ref-std').value;
            const auth = document.getElementById('ref-author').value || 'AUTHOR';
            const title = document.getElementById('ref-title').value || 'TITLE';
            const year = document.getElementById('ref-year').value || 'YEAR';
            let html = '';
            if (std === 'abnt') html = `${auth}. <b>${title}</b>. ${year}.`;
            else if (std === 'apa') html = `${auth}. (${year}). <i>${title}</i>.`;
            else html = `${auth}. <i>${title}</i>. ${year}.`;
            document.getElementById('ref-preview-output').innerHTML = html;
        }

        insertReference() {
            const html = document.getElementById('ref-preview-output').innerHTML;
            const p = document.createElement('p');
            p.innerHTML = html;
            p.style.marginBottom = "0"; 
            this.editor.appendChild(p);
            const newP = document.createElement('p');
            newP.innerHTML = '<br>';
            this.editor.appendChild(newP);
            this.closeModal('ref-modal');
            this.triggerAutoSave();
            Utils.toast('Reference Added');
        }

        setStandard(std) {
            this.currentStandard = std;
            document.querySelectorAll('.format-option').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.format-option[data-style="style-${std}"]`);
            if(activeBtn) activeBtn.classList.add('active');

            this.paper.className = '';
            this.paper.classList.add(`style-${std}`);

            const names = { abnt: 'ABNT (NBR 14724)', apa: 'APA (7th Ed)', mla: 'MLA (9th Ed)' };
            document.getElementById('status-std').innerText = `STD: ${names[std]}`;
            this.triggerAutoSave();
        }

        toggleCover() {
            const cover = document.getElementById('cover-page');
            const btnText = document.getElementById('cover-btn-text');
            const btn = document.getElementById('btn-toggle-cover');
            const isHidden = getComputedStyle(cover).display === 'none';
            
            if (isHidden) {
                cover.style.display = 'flex';
                btnText.innerText = 'Remove Cover Page';
                btn.classList.add('btn-danger');
                btn.classList.remove('btn-secondary');
            } else {
                cover.style.display = 'none';
                btnText.innerText = 'Insert Cover Page';
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-secondary');
            }
            this.triggerAutoSave();
        }

        updateStats() {
            const text = this.editor.innerText || '';
            const words = text.trim().split(/[\s\n]+/).filter(w => w.length > 0 && w.match(/[a-zA-Z0-9\u00C0-\u00FF]/)).length;
            const chars = text.length;
            const stats = document.getElementById('status-stats');
            if(stats) stats.innerText = `Words: ${words} | Chars: ${chars}`;
        }

        // UTILS
        openModal(id) {
            const modal = document.getElementById(id);
            if(modal) modal.classList.remove('hidden');
        }
        closeModal(id) {
            const modal = document.getElementById(id);
            if(modal) modal.classList.add('hidden');
        }
        toggleZen() {
            document.body.classList.toggle('focus-mode');
            const isActive = document.body.classList.contains('focus-mode');
            Utils.toast(isActive ? 'Zen Mode On' : 'Zen Mode Off');
        }
    }

    const Utils = {
        toast: (msg) => {
            const t = document.getElementById('toast-msg');
            if(!t) return;
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        }
    };

    window.addEventListener('DOMContentLoaded', () => {
        window.App = new ThesisApp();
        window.App.init();
    });
</script>
</body>
</html>
