<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thesis.web - Academic Suite</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#FFDE59">
    <meta name="description" content="ABNT, APA, MLA Academic Editor">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* =========================================
           1. NEO-BRUTALIST THEME VARIABLES
           ========================================= */
        :root {
            /* Palette */
            --c-bg: #e0e0e0;
            --c-panel: #ffffff;
            --c-border: #000000;
            --c-text: #000000;
            
            /* Accents */
            --c-primary: #FFDE59;   /* Acid Yellow */
            --c-secondary: #FF90E8; /* Hot Pink */
            --c-accent: #23C9FF;    /* Cyan */
            --c-success: #00E096;   /* Green */
            --c-danger: #FF5C5C;    /* Red */
            
            /* Structural */
            --border-width: 3px;
            --shadow-hard: 4px 4px 0px var(--c-border);
            --shadow-active: 2px 2px 0px var(--c-border);
            
            --font-ui: 'Courier New', Courier, monospace;
            
            /* Document Dimensions */
            --page-width: 210mm;
            --page-height: 297mm;
            --page-gap: 20px; /* The visual gap between sheets on screen */
        }

        /* Dark Mode Override */
        [data-theme="dark"] {
            --c-bg: #121212;
            --c-panel: #1e1e1e;
            --c-text: #ffffff;
            --c-border: #ffffff;
            --c-primary: #bfa300;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.3s;
        }

        /* =========================================
           2. UI COMPONENT CLASSES
           ========================================= */
        .btn {
            background: var(--c-panel);
            border: var(--border-width) solid var(--c-border);
            box-shadow: 2px 2px 0px var(--c-border);
            padding: 8px 12px;
            font-family: var(--font-ui);
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.1s;
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px;
            font-size: 11px;
            color: #000;
            user-select: none;
        }
        .btn:hover { 
            background: var(--c-primary); 
            transform: translate(-1px, -1px); 
            box-shadow: 3px 3px 0px var(--c-border); 
        }
        .btn:active, .btn.active { 
            background: var(--c-secondary); 
            transform: translate(2px, 2px); 
            box-shadow: 0px 0px 0px var(--c-border); 
        }
        
        .btn-primary { background: var(--c-primary); }
        .btn-secondary { background: var(--c-secondary); }
        .btn-accent { background: var(--c-accent); }
        .btn-danger { background: var(--c-danger); color: #fff; }
        
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; }
        .btn-full { width: 100%; }

        .panel {
            background: var(--c-panel);
            border: var(--border-width) solid var(--c-border);
            z-index: 10;
        }

        /* Form Elements */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 8px; border: 2px solid #000; font-family: var(--font-ui);
            background: var(--c-bg); color: var(--c-text);
            font-size: 13px; transition: background 0.2s;
        }
        .form-group input:focus, .form-group textarea:focus { background: #fff; }

        /* =========================================
           3. LAYOUT STRUCTURE
           ========================================= */
        header {
            height: 56px;
            border-bottom: var(--border-width) solid var(--c-border);
            background: var(--c-primary);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px;
            z-index: 20;
            flex-shrink: 0;
        }
        .logo { font-size: 18px; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 8px;}

        #app-container {
            display: flex; 
            flex: 1; 
            overflow: hidden; 
            position: relative;
        }

        /* SIDEBAR */
        #sidebar {
            width: 300px;
            border-right: var(--border-width) solid var(--c-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            background: var(--c-panel);
            transition: transform 0.3s ease;
        }

        .sidebar-section { padding: 15px; border-bottom: 2px solid var(--c-border); }
        .sidebar-title { font-weight: 900; margin-bottom: 10px; display: block; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid var(--c-primary); padding-bottom: 4px; display: inline-block;}

        .format-option {
            display: flex; align-items: center; width: 100%; text-align: left;
            margin-bottom: 8px; padding: 8px;
            border: 2px solid var(--c-border);
            cursor: pointer;
            background: #fff;
            font-weight: bold; font-size: 12px;
            transition: 0.1s;
        }
        .format-option:hover { background: #eee; transform: translateX(2px); }
        .format-option.active { background: var(--c-accent); color: #fff; border-color: #000; box-shadow: 2px 2px 0 #000; }

        /* Toolbar Grid */
        .toolbar-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 5px;
        }

        /* Checklist */
        .checklist-item {
            display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; font-weight: bold;
            cursor: pointer; user-select: none;
        }
        .checklist-item input { width: 16px; height: 16px; margin-right: 10px; accent-color: var(--c-success); cursor: pointer;}
        
        /* WORKSPACE (The Gray Area) */
        #workspace {
            flex: 1;
            background-color: #bbb;
            /* Graph paper grid pattern */
            background-image: linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: var(--c-bg);
            overflow: auto;
            padding: 40px 20px;
            display: flex; 
            flex-direction: column;
            align-items: center; /* Center the paper stack */
        }

        /* THE A4 PAPER STACK CONTAINER */
        #paper {
            width: var(--page-width); 
            /* Min-height removed to allow expansion, but content defines height */
            background: transparent; 
            box-shadow: none; /* Shadow handled by page backgrounds */
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 40px;
        }

        /* EDITOR AREA - Multi-Page Logic */
        #editor-area {
            flex: 1;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 0; 
            min-height: calc(var(--page-height) * 1); /* At least one page */
            width: 100%;
            
            /* THE MAGIC: Visual Infinite Stack */
            background-color: #fff;
            /* 
               Gradient Logic:
               1. White (Paper) from 0 to (PageHeight - 3px)
               2. Black (Border) from (PageHeight - 3px) to PageHeight
               3. Transparent (Gap) from PageHeight to (PageHeight + Gap)
               4. Repeat
            */
            background-image: 
                linear-gradient(to bottom, 
                    #fff 0px, 
                    #fff calc(var(--page-height) - 3px), 
                    #000 calc(var(--page-height) - 3px), 
                    #000 var(--page-height), 
                    transparent var(--page-height), 
                    transparent calc(var(--page-height) + var(--page-gap))
                );
            background-size: 100% calc(var(--page-height) + var(--page-gap));
            background-repeat: repeat-y;
            background-attachment: local; /* Scrolls with content */
            
            color: #000; /* Always black text on paper */
            position: relative;
        }

        /* Cover Page */
        #cover-page {
            height: var(--page-height); 
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-bottom: 0;
            
            /* Match the paper look */
            background-color: #fff;
            width: var(--page-width);
            border: 3px solid #000;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            
            /* Ensure separation from the next page */
            margin-bottom: var(--page-gap);
            
            /* Reset for specific standards */
            padding: 0; 
        }

        /* FOOTER */
        footer {
            height: 30px; background: var(--c-panel); border-top: var(--border-width) solid var(--c-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 11px;
            font-weight: bold; flex-shrink: 0;
        }

        /* =========================================
           4. ACADEMIC STYLES (The Magic)
           ========================================= */
        
        /* Common Paragraph Rules for Pagination */
        #editor-area p, #editor-area li {
            /* Keep text inside lines */
            orphans: 3;
            widows: 3;
        }
        
        /* Print Helper: Avoid breaking paragraphs mid-sentence if possible */
        @media print {
            #editor-area p, #editor-area h1, #editor-area h2, #editor-area li {
                break-inside: avoid;
            }
        }

        /* ABNT (Brazil - NBR 14724) */
        .style-abnt #editor-area, .style-abnt #cover-page {
            /* Margins simulated via padding */
            padding: 3cm 2cm 2cm 3cm;
        }
        
        .style-abnt #editor-area, .style-abnt p, .style-abnt li {
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.5;
            text-align: justify;
            margin-bottom: 0; 
            text-indent: 1.25cm;
        }
        /* Fix indent for first paragraph */
        .style-abnt p:first-of-type { text-indent: 1.25cm; }
        
        .style-abnt h1 { font-family: Arial, sans-serif; font-size: 14pt; font-weight: bold; text-align: center; margin: 20px 0 10px 0; text-indent: 0; }
        .style-abnt h2 { font-family: Arial, sans-serif; font-size: 12pt; font-weight: bold; text-align: left; margin: 10px 0; text-indent: 0; }
        
        /* Cover specific */
        .style-abnt #cover-page h1 { font-size: 16pt; margin-bottom: 40px; font-weight: bold; text-align: center; }
        .style-abnt #cover-page h2 { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin-bottom: 120px; text-align: center; }

        /* APA (US/Canada - 7th Ed) */
        .style-apa #editor-area, .style-apa #cover-page { padding: 1in; }
        
        .style-apa #editor-area, .style-apa p, .style-apa li {
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 2; /* Double spacing */
            text-align: left;
        }
        .style-apa p { margin-bottom: 0; text-indent: 0.5in; }
        .style-apa h1 { font-size: 12pt; font-weight: bold; text-align: center; margin-bottom: 10px; text-indent: 0; }
        .style-apa #cover-page h2 { font-size: 14pt; margin-bottom: 40px; text-align: center;}
        
        /* MLA (Humanities - 9th Ed) */
        .style-mla #editor-area, .style-mla #cover-page { padding: 1in; }
        
        .style-mla #editor-area, .style-mla p {
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1;
            text-align: left;
            margin-bottom: 10px;
        }
        .style-mla h1 { font-size: 14pt; font-weight: bold; text-align: left; margin-bottom: 5px; }

        /* =========================================
           5. MODALS & UTILS
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: var(--c-panel); border: var(--border-width) solid var(--c-border);
            width: 90%; max-width: 500px;
            padding: 20px;
            box-shadow: 10px 10px 0px #000;
            display: flex; flex-direction: column; gap: 10px;
            animation: slideIn 0.2s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes slideIn { from {transform: translateY(20px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .modal-header { font-size: 18px; font-weight: 900; margin-bottom: 10px; border-bottom: 3px solid #000; padding-bottom: 10px;}
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: var(--c-primary); color: #000;
            padding: 10px 20px; border: 2px solid #000;
            box-shadow: 4px 4px 0px #000;
            font-weight: bold; z-index: 2000;
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        .toast.hidden { display: none; }
        @keyframes popUp { from {transform: translate(-50%, 100%); opacity: 0;} to {transform: translate(-50%, 0); opacity: 1;} }

        /* Focus Mode */
        body.focus-mode #sidebar, body.focus-mode header, body.focus-mode footer, 
        body.focus-mode .modal-overlay, body.focus-mode .toast, 
        body.focus-mode #zen-toggle-wrapper {
            display: none !important;
        }
        body.focus-mode #workspace { padding: 0; background: #888; }
        body.focus-mode #paper { box-shadow: none; margin: 40px auto; width: 210mm; }
        
        #zen-toggle-wrapper { position: fixed; top: 70px; right: 20px; z-index: 100; display: none; }
        body.focus-mode #zen-toggle-wrapper { display: block; }

        /* =========================================
           6. PRINT ENGINE (The critical part)
           ========================================= */
        @media print {
            /* Hide UI */
            body { background: white; height: auto; overflow: visible; display: block; }
            header, #sidebar, footer, .modal-overlay, .toast, .toolbar-grid, #zen-toggle-wrapper, #mobile-menu-btn { display: none !important; }
            
            /* Show only paper content */
            #workspace { padding: 0; background: white; display: block; overflow: visible; }
            
            #paper {
                box-shadow: none; margin: 0; width: 100%; padding: 0; min-height: auto;
                border: none;
            }

            /* 
               Remove the visual page separator background for print 
               because the browser handles actual physical pages.
            */
            #editor-area {
                background-image: none !important;
                background: white !important;
                width: 100%;
            }

            /* FORCE PAGE MARGINS - Use @page to override browser defaults */
            @page {
                size: A4;
                margin: 0; /* We handle margins inside #editor-area to avoid browser double margins */
            }
            
            /* Ensure Cover Page breaks correctly */
            #cover-page { 
                page-break-after: always; 
                border: none; 
                box-shadow: none;
                margin: 0;
                min-height: auto;
                height: auto;
                padding-top: 3cm !important; /* Force standard print padding */
            }
            
            /* Handle the bottom of the last page */
            #editor-area::after {
                content: "";
                display: block;
                height: 20px; /* little buffer */
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; z-index: 50; transform: translateX(-100%); background: var(--c-panel); box-shadow: 5px 0 0 #000;}
            #sidebar.mobile-active { transform: translateX(0); }
            #mobile-menu-btn { display: block !important; }
            #zen-toggle-wrapper { display: none !important; }
        }
        #mobile-menu-btn { display: none; position: absolute; top: 10px; left: 10px; z-index: 60; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <button class="btn btn-icon" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        <div class="logo"><i class="fas fa-graduation-cap"></i> THESIS.WEB <span style="font-size:10px; font-weight:normal; margin-left:5px; background:#000; color:#fff; padding:2px 4px;">BETA</span></div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-sm" id="btn-guide" title="Open Guide"><i class="fas fa-book"></i> Guide</button>
            <button class="btn btn-sm btn-accent" id="btn-ref" title="Insert Reference"><i class="fas fa-book-open"></i> Refs</button>
            <button class="btn btn-sm btn-primary" id="btn-save"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-sm" id="btn-print"><i class="fas fa-print"></i> PDF</button>
            <button class="btn btn-sm" id="btn-zen" title="Focus Mode"><i class="fas fa-expand"></i></button>
        </div>
    </header>

    <div id="app-container">
        
        <!-- SIDEBAR -->
        <aside class="panel" id="sidebar">
            <!-- Standard Selection -->
            <div class="sidebar-section">
                <span class="sidebar-title">1. Standard</span>
                <button class="format-option active" data-style="style-abnt" onclick="App.setStandard('abnt')">
                    <i class="fas fa-flag"></i> ABNT (NBR 14724)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Arial 12pt, 1.5</div>
                </button>
                <button class="format-option" data-style="style-apa" onclick="App.setStandard('apa')">
                    <i class="fas fa-landmark"></i> APA (7th Ed)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Times, Double</div>
                </button>
                <button class="format-option" data-style="style-mla" onclick="App.setStandard('mla')">
                    <i class="fas fa-university"></i> MLA (9th Ed)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Times, Single</div>
                </button>
            </div>

            <!-- Formatting Tools -->
            <div class="sidebar-section">
                <span class="sidebar-title">2. Text Format</span>
                <div class="toolbar-grid">
                    <button class="btn btn-sm" onclick="App.exec('bold')"><b>B</b></button>
                    <button class="btn btn-sm" onclick="App.exec('italic')"><i>I</i></button>
                    <button class="btn btn-sm" onclick="App.exec('underline')"><u>U</u></button>
                    <button class="btn btn-sm" onclick="App.exec('strikeThrough')"><s>S</s></button>
                </div>
                <div class="toolbar-grid">
                    <button class="btn btn-sm" onclick="App.exec('justifyLeft')"><i class="fas fa-align-left"></i></button>
                    <button class="btn btn-sm" onclick="App.exec('justifyCenter')"><i class="fas fa-align-center"></i></button>
                    <button class="btn btn-sm" onclick="App.exec('justifyRight')"><i class="fas fa-align-right"></i></button>
                    <button class="btn btn-sm" onclick="App.exec('justifyFull')"><i class="fas fa-align-justify"></i></button>
                </div>
                <div style="margin-top:10px;">
                    <button class="btn btn-sm btn-full" onclick="App.exec('insertUnorderedList')"><i class="fas fa-list-ul"></i> Bullet List</button>
                    <button class="btn btn-sm btn-full" style="margin-top:5px;" onclick="App.exec('insertOrderedList')"><i class="fas fa-list-ol"></i> Numbered List</button>
                </div>
            </div>

            <!-- Page Tools -->
            <div class="sidebar-section">
                <span class="sidebar-title">3. Page Tools</span>
                <button class="btn btn-sm btn-secondary btn-full" id="btn-toggle-cover" onclick="App.toggleCover()">
                    <i class="fas fa-file"></i> <span id="cover-btn-text">Insert Cover Page</span>
                </button>
                <small style="display:block; margin:8px 0; color:#666; line-height:1.2;">Auto-formats cover for selected standard.</small>
                
                <button class="btn btn-sm btn-secondary btn-full" style="margin-bottom:8px;" onclick="App.insertStructure('abstract')">
                    <i class="fas fa-heading"></i> Insert Abstract
                </button>
                <button class="btn btn-sm btn-secondary btn-full" onclick="App.insertStructure('references')">
                    <i class="fas fa-book-open"></i> Insert Ref. Header
                </button>
                <button class="btn btn-sm btn-danger btn-full" style="margin-top:8px;" onclick="App.clearPaper()"><i class="fas fa-trash"></i> Clear Paper</button>
            </div>

            <!-- Checklist -->
            <div class="sidebar-section">
                <span class="sidebar-title">4. Pre-flight Checklist</span>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-1"><span>Margins correct?</span>
                </div>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-2"><span>Font size correct?</span>
                </div>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-3"><span>Refs validated?</span>
                </div>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-4"><span>Spelling checked?</span>
                </div>
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main id="workspace">
            <div id="paper" class="style-abnt">
                <!-- Cover Page (Dynamic Content) -->
                <div id="cover-page">
                    <h2 contenteditable="true" id="cover-inst">INSTITUTION NAME</h2>
                    <h3 contenteditable="true" id="cover-author">Author Name</h3>
                    <h1 contenteditable="true" id="cover-title">Title of the Work</h1>
                    <div style="margin-top:100px; text-align:center; line-height:1.5; text-indent:0;">
                        <p contenteditable="true">City</p>
                        <p contenteditable="true">Year</p>
                    </div>
                </div>

                <!-- Main Text Editor -->
                <div id="editor-area" contenteditable="true" spellcheck="false">
                    <h1>Introduction</h1>
                    <p>Start writing your academic work here. The text will automatically adjust to the selected standard (ABNT, APA, or MLA).</p>
                    <p>Notice how the editor creates a visual "stack" of pages. As you type past the first page, a new page will appear below. This mimics a real document.</p>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                    <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                    <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
                    <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- FOOTER -->
    <footer>
        <div id="status-std">STD: ABNT (NBR 14724)</div>
        <div id="status-stats">Words: 0 | Chars: 0</div>
        <div id="status-save"><i class="fas fa-check-circle" style="color:var(--c-success)"></i> Ready</div>
    </footer>

    <!-- FOCUS MODE TOGGLE -->
    <div id="zen-toggle-wrapper">
        <button class="btn btn-icon" onclick="App.toggleZen()">
            <i class="fas fa-compress"></i>
        </button>
    </div>

    <!-- GUIDE MODAL -->
    <div class="modal-overlay hidden" id="guide-modal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-info-circle"></i> Quick Guide</div>
            <div style="font-size:12px; line-height:1.6; max-height:300px; overflow-y:auto;">
                <b>1. Standard:</b> Choose ABNT, APA, or MLA from the sidebar. This sets fonts, margins, and spacing.
                <br><br>
                <b>2. Writing:</b> Type in the main area. The editor now simulates a stack of pages. When you fill one page, text flows to the next.
                <br><br>
                <b>3. References:</b> Click the <b>"Refs"</b> button. Fill in the form to generate a correctly formatted Bibliography entry.
                <br><br>
                <b>4. Export:</b> <b>"Save"</b> downloads an .html file. <b>"PDF"</b> opens the print dialog.
                <br><br>
                <i style="color:var(--c-danger)">Important for PDF:</i> In print settings, uncheck "Headers and Footers" and ensure margins are set to "None" or "Default" (the app handles page margins).
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-primary" onclick="App.closeModal('guide-modal')">Got it</button>
            </div>
        </div>
    </div>

    <!-- REFERENCE GENERATOR MODAL -->
    <div class="modal-overlay hidden" id="ref-modal">
        <div class="modal-content">
            <div class="modal-header">Reference Generator</div>
            
            <div class="form-group">
                <label>Format Standard</label>
                <select id="ref-std" onchange="App.updateRefPreview()">
                    <option value="abnt">ABNT (NBR 14724)</option>
                    <option value="apa">APA (7th Ed.)</option>
                    <option value="mla">MLA (9th Ed.)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Author (Surname, Name)</label>
                <input type="text" id="ref-author" placeholder="Silva, João" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="ref-title" placeholder="Book Title" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Subtitle (Optional)</label>
                <input type="text" id="ref-subtitle" placeholder="Subtitle" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Edition (Optional)</label>
                <input type="text" id="ref-edition" placeholder="e.g. 2nd ed." oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" id="ref-city" placeholder="Sao Paulo" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Publisher</label>
                <input type="text" id="ref-pub" placeholder="Editora XYZ" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Year</label>
                <input type="number" id="ref-year" placeholder="2023" oninput="App.updateRefPreview()">
            </div>

            <!-- Live Preview -->
            <div style="background:#eee; border:2px dashed #000; padding:10px; margin-bottom:10px; font-family:serif; font-size:12px;">
                <label style="font-family:var(--font-ui); font-size:10px; display:block; margin-bottom:4px;">PREVIEW:</label>
                <div id="ref-preview-output" style="color:#000;">...</div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('ref-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertReference()"><i class="fas fa-plus"></i> Insert Ref</button>
            </div>
        </div>
    </div>

    <!-- PRINT INSTRUCTION MODAL -->
    <div class="modal-overlay hidden" id="print-modal">
        <div class="modal-content" style="border-color: var(--c-accent);">
            <div class="modal-header"><i class="fas fa-exclamation-triangle"></i> Print Setup</div>
            <div style="font-size:13px; line-height:1.5;">
                <p>To get a professional PDF without browser junk (URLs, dates), please check these settings in the print dialog:</p>
                <ol style="margin-left:20px; margin-top:10px;">
                    <li><b>More settings</b> -> Uncheck <b>"Headers and footers"</b>.</li>
                    <li>Check <b>"Background graphics"</b> (if you want highlight colors).</li>
                    <li>Set margins to <b>"Default"</b> or <b>"None"</b> (The editor handles the academic margins).</li>
                </ol>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('print-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.confirmPrint()"><i class="fas fa-print"></i> Print Now</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast hidden" id="toast-msg">Action Successful</div>

    <script>
        class ThesisApp {
            constructor() {
                // DOM Elements
                this.paper = document.getElementById('paper');
                this.editor = document.getElementById('editor-area');
                this.currentStandard = 'abnt';
                
                // Debounce timer for auto-save
                this.saveTimer = null;
            }

            init() {
                console.log("Thesis.web System Initialized.");
                this.loadState();
                this.bindEvents();
                this.updateStats();
                Utils.toast('System Ready');
            }

            // --- CORE EDITOR FUNCTIONS ---
            exec(command, value = null) {
                document.execCommand(command, false, value);
                this.editor.focus();
                this.triggerAutoSave();
            }

            bindEvents() {
                // Editor Input Events
                this.editor.addEventListener('input', () => {
                    this.updateStats();
                    this.triggerAutoSave();
                });

                // Global Buttons
                document.getElementById('btn-save').onclick = () => this.downloadHTML();
                document.getElementById('btn-print').onclick = () => this.openModal('print-modal');
                document.getElementById('btn-ref').onclick = () => this.openRefModal();
                document.getElementById('btn-guide').onclick = () => this.openModal('guide-modal');
                document.getElementById('btn-zen').onclick = () => this.toggleZen();
                
                // Mobile Menu
                document.getElementById('mobile-menu-btn').onclick = () => {
                    document.getElementById('sidebar').classList.toggle('mobile-active');
                };

                // Close modals on overlay click
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if(e.target === overlay) this.closeModal(overlay.id);
                    });
                });
            }

            // --- ACADEMIC STANDARDS LOGIC ---
            setStandard(std) {
                this.currentStandard = std;
                
                // 1. Update Sidebar UI
                document.querySelectorAll('.format-option').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`.format-option[data-style="style-${std}"]`);
                if(activeBtn) activeBtn.classList.add('active');

                // 2. Update Paper Class (This triggers CSS changes)
                this.paper.className = '';
                this.paper.classList.add(`style-${std}`);

                // 3. Update Footer Status
                const names = { 
                    abnt: 'ABNT (NBR 14724)', 
                    apa: 'APA (7th Ed)', 
                    mla: 'MLA (9th Ed)' 
                };
                document.getElementById('status-std').innerText = `STD: ${names[std]}`;

                // 4. Update Dynamic Labels (Cover Page, Structures)
                this.updateStandardLabels(std);

                this.saveState();
                Utils.toast(`Switched to ${names[std]}`);
            }

            updateStandardLabels(std) {
                // Update Cover Page Defaults based on language/standard style
                const inst = document.getElementById('cover-inst');
                const title = document.getElementById('cover-title');

                if (std === 'abnt') {
                    if(inst.innerText === 'INSTITUTION NAME' || inst.innerText === 'University Name') inst.innerText = 'NOME DA INSTITUIÇÃO';
                    // No strict title caps for ABNT usually, but layout is specific
                } else {
                    if(inst.innerText === 'NOME DA INSTITUIÇÃO') inst.innerText = 'University Name';
                    if(std === 'apa') title.style.textDecoration = 'none';
                }
            }

            // --- COVER PAGE LOGIC ---
            toggleCover() {
                const cover = document.getElementById('cover-page');
                const btnText = document.getElementById('cover-btn-text');
                const btn = document.getElementById('btn-toggle-cover');
                
                const isHidden = getComputedStyle(cover).display === 'none';
                
                if (isHidden) {
                    cover.style.display = 'flex';
                    btnText.innerText = 'Remove Cover Page';
                    btn.classList.add('btn-danger');
                    btn.classList.remove('btn-secondary');
                } else {
                    cover.style.display = 'none';
                    btnText.innerText = 'Insert Cover Page';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-secondary');
                }
                this.triggerAutoSave();
            }

            // --- REFERENCE GENERATOR ---
            openRefModal() {
                // Set the dropdown to current app standard
                document.getElementById('ref-std').value = this.currentStandard;
                // Clear fields
                ['ref-author','ref-title','ref-subtitle','ref-edition','ref-city','ref-pub','ref-year'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                this.updateRefPreview();
                this.openModal('ref-modal');
            }

            updateRefPreview() {
                const std = document.getElementById('ref-std').value;
                const auth = document.getElementById('ref-author').value || 'AUTHOR';
                const title = document.getElementById('ref-title').value || 'TITLE';
                const sub = document.getElementById('ref-subtitle').value;
                const edition = document.getElementById('ref-edition').value;
                const city = document.getElementById('ref-city').value || 'CITY';
                const pub = document.getElementById('ref-pub').value || 'PUBLISHER';
                const year = document.getElementById('ref-year').value || 'YEAR';

                let html = '';

                // Simplified Logic for common book citations
                if (std === 'abnt') {
                    // ABNT: AUTHOR. <b>Title</b>: subtitle. Edition. City: Publisher, Year.
                    html = `${auth}. <b>${title}</b>${sub ? ': ' + sub : ''}${edition ? '. ' + edition : ''}. ${city}: ${pub}, ${year}.`;
                } else if (std === 'apa') {
                    // APA: Author. (Year). <i>Title</i>. Publisher.
                    html = `${auth}. (${year}). <i>${title}</i>. ${pub}.`;
                } else {
                    // MLA: Author. <i>Title</i>. Publisher, Year.
                    html = `${auth}. <i>${title}</i>. ${pub}, ${year}.`;
                }

                document.getElementById('ref-preview-output').innerHTML = html;
            }

            insertReference() {
                const html = document.getElementById('ref-preview-output').innerHTML;
                const p = document.createElement('p');
                p.innerHTML = html;
                
                // Ensure it has correct styling class
                p.style.marginBottom = "0"; 
                
                this.editor.appendChild(p);
                
                // Move cursor to end
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(p);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
                
                this.closeModal('ref-modal');
                this.triggerAutoSave();
                Utils.toast('Reference Added');
            }

            // --- STRUCTURE HELPERS ---
            insertStructure(type) {
                const h2 = document.createElement('h2');
                let label = '';
                
                if(type === 'abstract') {
                    label = (this.currentStandard === 'abnt') ? 'RESUMO' : 'ABSTRACT';
                    // Insert at top of editor, after cover logic is separate
                    this.editor.insertBefore(h2, this.editor.firstChild);
                    
                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    this.editor.insertBefore(p, this.editor.children[1]);
                    
                } else if (type === 'references') {
                    label = (this.currentStandard === 'abnt') ? 'REFERÊNCIAS' : 'REFERENCES';
                    this.editor.appendChild(h2);
                    
                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    this.editor.appendChild(p);
                }
                
                h2.innerText = label;
                this.triggerAutoSave();
                Utils.toast(`${label} Section Added`);
            }

            clearPaper() {
                if(confirm('Are you sure? This will wipe all text and cannot be undone.')) {
                    this.editor.innerHTML = '<p>Start writing...</p>';
                    this.updateStats();
                    this.triggerAutoSave();
                }
            }

            // --- EXPORT & PRINT ---
            confirmPrint() {
                this.closeModal('print-modal');
                setTimeout(() => {
                    window.print();
                }, 300);
            }

            downloadHTML() {
                const stdName = this.currentStandard.toUpperCase();
                const date = new Date().toISOString().slice(0,10);
                
                // We clone the paper to clean it up if necessary, or just take outerHTML
                let content = this.paper.outerHTML;
                
                // Generate minimal CSS for the downloaded file
                // We use the existing styles but simplified for the standalone file
                let css = `
                    body { font-family: Arial, sans-serif; line-height: 1.5; }
                    .style-apa, .style-mla { font-family: "Times New Roman", serif; }
                    #paper { width: 210mm; margin: 0 auto; }
                    .style-abnt #editor-area { padding: 3cm 2cm 2cm 3cm; font-size: 12pt; text-align: justify; }
                    .style-apa #editor-area { padding: 1in; font-size: 12pt; line-height: 2; }
                    .style-mla #editor-area { padding: 1in; font-size: 12pt; }
                    #cover-page { min-height: 297mm; border-bottom: 1px solid #ccc; margin-bottom: 20px; display:flex; flex-direction:column; justify-content:center; align-items:center; page-break-after: always;}
                    h1 { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 10px; }
                    h2 { font-size: 12pt; font-weight: bold; margin-bottom: 10px; }
                    p { margin-bottom: 0; }
                `;

                const htmlFull = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Thesis_${date}_${stdName}</title>
    <style>
        ${css}
    </style>
</head>
<body>
    ${content}
</body>
</html>
                `;
                
                const blob = new Blob([htmlFull], {type: 'text/html'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Thesis_${date}_${stdName.toLowerCase()}.html`;
                a.click();
                Utils.toast('HTML Downloaded');
            }

            // --- UTILITIES ---
            updateStats() {
                const text = this.editor.innerText || '';
                // Better word count regex
                const words = text.trim().split(/[\s\n]+/).filter(w => w.length > 0 && w.match(/[a-zA-Z0-9\u00C0-\u00FF]/)).length;
                const chars = text.length;
                document.getElementById('status-stats').innerText = `Words: ${words} | Chars: ${chars}`;
            }

            triggerAutoSave() {
                const status = document.getElementById('status-save');
                status.innerHTML = '<i class="fas fa-pen"></i> Saving...';
                
                if(this.saveTimer) clearTimeout(this.saveTimer);
                
                this.saveTimer = setTimeout(() => {
                    this.saveState();
                    status.innerHTML = '<i class="fas fa-check-circle" style="color:var(--c-success)"></i> Saved';
                }, 1000);
            }

            saveState() {
                localStorage.setItem('thesis-content', this.paper.outerHTML);
                localStorage.setItem('thesis-std', this.currentStandard);
                localStorage.setItem('thesis-checklist', document.getElementById('sidebar').innerHTML);
            }

            loadState() {
                const savedStd = localStorage.getItem('thesis-std');
                if(savedStd) {
                    this.setStandard(savedStd);
                } else {
                    this.setStandard('abnt');
                }
                
                const saved = localStorage.getItem('thesis-content');
                if(saved) {
                    const temp = document.createElement('div');
                    temp.innerHTML = saved;
                    const newPaper = temp.firstElementChild;
                    
                    // Only swap if valid
                    if(newPaper && newPaper.id === 'paper') {
                        newPaper.id = 'paper-loaded'; // temporary id
                        this.paper.parentNode.replaceChild(newPaper, this.paper);
                        newPaper.id = 'paper'; // restore id
                        this.paper = newPaper; // update ref
                        this.editor = document.getElementById('editor-area'); // update ref
                    }
                }
                
                // Restore checklist visual state (simple innerHTML swap)
                // Note: In a real app we'd bind state, but for UI persistence this works
                /*
                const savedChecklist = localStorage.getItem('thesis-checklist');
                if(savedChecklist) {
                     // Logic to re-check boxes could go here
                }
                */
               
                this.updateStats();
            }

            // --- MODAL SYSTEM ---
            openModal(id) {
                const modal = document.getElementById(id);
                if(modal) modal.classList.remove('hidden');
            }

            closeModal(id) {
                const modal = document.getElementById(id);
                if(modal) modal.classList.add('hidden');
            }

            toggleZen() {
                document.body.classList.toggle('focus-mode');
                Utils.toast(document.body.classList.contains('focus-mode') ? 'Zen Mode On' : 'Zen Mode Off');
            }
        }

        // Utility Wrapper
        const Utils = {
            toast: (msg) => {
                const t = document.getElementById('toast-msg');
                t.innerText = msg;
                t.classList.remove('hidden');
                setTimeout(() => t.classList.add('hidden'), 2500);
            }
        };

        // Bootstrap
        window.addEventListener('DOMContentLoaded', () => {
            window.App = new ThesisApp();
            window.App.init();
        });

    </script>
</body>
</html>
