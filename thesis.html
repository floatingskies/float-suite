<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thesis - Academic Writing Suite</title>
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Editor Academico ABNT, APA, MLA">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --c-bg: #f8fafc;
            --c-panel: #ffffff;
            --c-panel-alt: #f1f5f9;
            --c-border: #e2e8f0;
            --c-border-strong: #cbd5e1;
            --c-text: #1e293b;
            --c-text-muted: #64748b;
            --c-text-light: #94a3b8;
            
            --c-primary: #2563eb;
            --c-primary-hover: #1d4ed8;
            --c-primary-light: #dbeafe;
            --c-secondary: #7c3aed;
            --c-accent: #059669;
            --c-info: #0891b2;
            --c-warning: #d97706;
            --c-danger: #dc2626;
            
            --radius-sm: 4px;
            --radius: 6px;
            --radius-lg: 8px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            
            --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-serif: 'Source Serif 4', Georgia, serif;
            
            --page-width: 210mm;
            --page-height: 297mm;
            --page-gap: 24px;
            
            --sidebar-width: 300px;
            --header-height: 52px;
            --toolbar-height: 44px;
            --footer-height: 28px;
        }

        [data-theme="dark"] {
            --c-bg: #0f172a;
            --c-panel: #1e293b;
            --c-panel-alt: #334155;
            --c-border: #334155;
            --c-border-strong: #475569;
            --c-text: #f1f5f9;
            --c-text-muted: #94a3b8;
            --c-text-light: #64748b;
            --c-primary-light: #1e3a5f;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background 0.2s, color 0.2s;
        }

        /* Buttons */
        .btn {
            background: var(--c-panel);
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            padding: 8px 14px;
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--c-text);
            white-space: nowrap;
        }
        .btn:hover:not(:disabled) {
            background: var(--c-panel-alt);
            border-color: var(--c-border-strong);
        }
        .btn:active:not(:disabled) {
            transform: translateY(1px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { 
            background: var(--c-primary); 
            border-color: var(--c-primary);
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) { 
            background: var(--c-primary-hover);
            border-color: var(--c-primary-hover);
        }
        .btn-accent { background: var(--c-accent); border-color: var(--c-accent); color: #fff; }
        .btn-danger { background: var(--c-danger); border-color: var(--c-danger); color: #fff; }
        .btn-ghost { 
            background: transparent; 
            border-color: transparent; 
        }
        .btn-ghost:hover { 
            background: var(--c-panel-alt); 
        }
        
        .btn-sm { padding: 6px 10px; font-size: 12px; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }
        .btn-icon { width: 34px; height: 34px; padding: 0; }
        .btn-icon-sm { width: 28px; height: 28px; padding: 0; }
        .btn-full { width: 100%; }

        /* Header */
        header {
            height: var(--header-height);
            border-bottom: 1px solid var(--c-border);
            background: var(--c-panel);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 100;
            flex-shrink: 0;
            gap: 12px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--c-primary);
        }
        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--c-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
        }

        .header-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Toolbar */
        .toolbar {
            height: var(--toolbar-height);
            background: var(--c-panel);
            border-bottom: 1px solid var(--c-border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            gap: 4px;
            overflow-x: auto;
            flex-shrink: 0;
        }
        .toolbar::-webkit-scrollbar { display: none; }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 0 6px;
            border-right: 1px solid var(--c-border);
        }
        .toolbar-group:last-child { border-right: none; }

        .toolbar-btn {
            width: 30px;
            height: 30px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: var(--c-text-muted);
            transition: all 0.15s;
        }
        .toolbar-btn:hover {
            background: var(--c-panel-alt);
            color: var(--c-text);
        }
        .toolbar-btn.active {
            background: var(--c-primary-light);
            color: var(--c-primary);
            border-color: var(--c-primary);
        }
        
        .toolbar-select {
            height: 30px;
            padding: 0 28px 0 10px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius-sm);
            background: var(--c-panel);
            font-family: var(--font-ui);
            font-size: 12px;
            color: var(--c-text);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2364748b' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
        .toolbar-select:hover {
            border-color: var(--c-border-strong);
        }

        /* Main Container */
        #app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            border-right: 1px solid var(--c-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            background: var(--c-panel);
            transition: transform 0.3s ease;
        }

        .sidebar-section {
            padding: 14px;
            border-bottom: 1px solid var(--c-border);
        }
        .sidebar-section:last-child { border-bottom: none; }
        
        .sidebar-title {
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            color: var(--c-text-muted);
        }

        /* Document List */
        #doc-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            background: var(--c-panel-alt);
        }
        #doc-list:empty::after {
            content: 'No saved documents';
            display: block;
            padding: 16px;
            text-align: center;
            color: var(--c-text-light);
            font-size: 12px;
        }
        
        .doc-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--c-border);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.15s;
            background: var(--c-panel);
        }
        .doc-item:last-child { border-bottom: none; }
        .doc-item:hover { background: var(--c-panel-alt); }
        .doc-item.active {
            background: var(--c-primary-light);
            border-left: 3px solid var(--c-primary);
        }
        .doc-item-icon { color: var(--c-text-muted); font-size: 14px; }
        .doc-item-info { flex: 1; min-width: 0; }
        .doc-item-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        .doc-item-date {
            font-size: 10px;
            color: var(--c-text-light);
            margin-top: 2px;
        }
        .doc-item-actions {
            display: flex;
            gap: 4px;
        }
        .doc-item-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--c-text-light);
            padding: 4px;
            font-size: 12px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }
        .doc-item-btn:hover { 
            color: var(--c-danger); 
            background: rgba(220, 38, 38, 0.1);
        }

        /* Format Options */
        .format-option {
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            margin-bottom: 6px;
            padding: 10px 12px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            cursor: pointer;
            background: var(--c-panel);
            font-weight: 500;
            font-size: 12px;
            transition: all 0.15s;
            gap: 10px;
        }
        .format-option:hover {
            border-color: var(--c-border-strong);
            background: var(--c-panel-alt);
        }
        .format-option.active {
            background: var(--c-primary-light);
            border-color: var(--c-primary);
        }
        .format-option-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--c-panel-alt);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 700;
        }
        .format-option.active .format-option-icon {
            background: var(--c-primary);
            color: #fff;
        }
        .format-option-info { flex: 1; }
        .format-option-name { font-weight: 600; }
        .format-option-desc {
            font-size: 10px;
            font-weight: 400;
            color: var(--c-text-muted);
            margin-top: 2px;
        }

        /* Workspace */
        #workspace {
            flex: 1;
            background: var(--c-panel-alt);
            overflow: auto;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* Pages Container */
        .pages-container {
            display: flex;
            flex-direction: column;
            gap: var(--page-gap);
            align-items: center;
        }

        /* Paper */
        .paper {
            width: var(--page-width);
            min-height: var(--page-height);
            background: #fff;
            box-shadow: var(--shadow-lg);
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }

        /* Cover Page */
        #cover-page {
            min-height: var(--page-height);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 3cm;
            background: #fff;
        }

        /* Editor Area */
        #editor-area {
            min-height: calc(var(--page-height) - 6cm);
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 3cm;
            color: #000;
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.5;
            text-align: justify;
        }
        #editor-area:focus { outline: none; }
        
        #editor-area img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 12px 0;
        }
        
        #editor-area figure {
            margin: 16px 0;
            text-align: center;
        }
        
        #editor-area figcaption {
            font-size: 10pt;
            color: #666;
            margin-top: 8px;
        }

        #editor-area table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        
        #editor-area table td,
        #editor-area table th {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        
        #editor-area table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        #editor-area blockquote {
            border-left: 3px solid var(--c-primary);
            margin: 16px 0;
            padding: 12px 16px;
            background: #f8fafc;
            position: relative;
        }
        #editor-area blockquote::after {
            content: 'Press Enter twice to exit';
            position: absolute;
            bottom: 2px;
            right: 8px;
            font-size: 9px;
            color: #94a3b8;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #editor-area blockquote:focus-within::after {
            opacity: 1;
        }

        #editor-area code {
            font-family: 'Consolas', monospace;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11pt;
        }

        #editor-area pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            font-size: 10pt;
            border-radius: var(--radius);
            margin: 12px 0;
        }

        #editor-area hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 24px 0;
        }

        #editor-area a {
            color: var(--c-primary);
            text-decoration: underline;
        }

        #editor-area .page-break {
            page-break-after: always;
            border-top: 1px dashed #cbd5e1;
            margin-top: 20px;
            padding-top: 20px;
            text-align: center;
        }
        #editor-area .page-break::before {
            content: '--- Page Break ---';
            font-size: 9pt;
            color: #94a3b8;
        }

        /* Academic Styles */
        .style-abnt #editor-area,
        .style-abnt #cover-page {
            padding: 3cm 2cm 2cm 3cm;
        }
        .style-abnt p,
        .style-abnt li {
            text-indent: 1.25cm;
            margin-bottom: 0;
        }
        .style-abnt h1 {
            font-size: 14pt;
            font-weight: bold;
            text-align: center;
            margin: 24px 0 12px;
            text-indent: 0;
        }
        .style-abnt h2 {
            font-size: 12pt;
            font-weight: bold;
            margin: 12px 0;
            text-indent: 0;
        }

        .style-apa #editor-area,
        .style-apa #cover-page {
            padding: 1in;
            font-family: 'Times New Roman', serif;
        }
        .style-apa p,
        .style-apa li {
            text-indent: 0.5in;
            line-height: 2;
            margin-bottom: 0;
        }
        .style-apa h1 {
            font-size: 12pt;
            font-weight: bold;
            text-align: center;
            margin: 12px 0;
            text-indent: 0;
        }

        .style-mla #editor-area,
        .style-mla #cover-page {
            padding: 1in;
            font-family: 'Times New Roman', serif;
        }
        .style-mla p {
            text-indent: 0.5in;
            line-height: 2;
        }

        /* Footer */
        footer {
            height: var(--footer-height);
            background: var(--c-panel);
            border-top: 1px solid var(--c-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: var(--c-text-muted);
            flex-shrink: 0;
        }
        .footer-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .footer-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            padding: 20px;
        }
        .modal-overlay.hidden { display: none; }
        
        .modal {
            background: var(--c-panel);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalIn 0.2s ease;
        }
        @keyframes modalIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--c-border);
            font-weight: 600;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--c-text-muted);
            padding: 4px;
            border-radius: var(--radius-sm);
            transition: all 0.15s;
        }
        .modal-close:hover { 
            color: var(--c-danger); 
            background: rgba(220, 38, 38, 0.1);
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--c-border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block;
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--c-text-muted);
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            font-family: var(--font-ui);
            font-size: 13px;
            background: var(--c-panel);
            color: var(--c-text);
            transition: all 0.15s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--c-primary);
            box-shadow: 0 0 0 3px var(--c-primary-light);
        }
        .form-input::placeholder { color: var(--c-text-light); }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--c-border);
            margin: -20px -20px 20px;
        }
        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--c-text-muted);
            margin-bottom: -1px;
        }
        .tab:hover { color: var(--c-text); }
        .tab.active {
            color: var(--c-primary);
            border-bottom-color: var(--c-primary);
        }
        .tab-content { padding: 0; }
        .tab-content.hidden { display: none; }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: var(--c-panel);
            color: var(--c-text);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            font-weight: 500;
            font-size: 13px;
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 3px solid var(--c-primary);
        }
        .toast.success { border-left-color: var(--c-accent); }
        .toast.error { border-left-color: var(--c-danger); }
        .toast.info { border-left-color: var(--c-info); }
        @keyframes toastIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--c-panel);
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1500;
            min-width: 160px;
            padding: 4px 0;
        }
        .context-menu.hidden { display: none; }
        .context-menu-item {
            padding: 8px 14px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.1s;
        }
        .context-menu-item:hover { background: var(--c-panel-alt); }
        .context-menu-item i { width: 14px; text-align: center; color: var(--c-text-muted); }
        .context-menu-divider {
            height: 1px;
            background: var(--c-border);
            margin: 4px 0;
        }

        /* Zen Mode */
        body.zen-mode #sidebar,
        body.zen-mode header,
        body.zen-mode footer,
        body.zen-mode .toolbar {
            display: none !important;
        }
        body.zen-mode #workspace {
            padding: 40px 20px;
        }
        body.zen-mode .paper {
            box-shadow: var(--shadow-lg);
        }
        
        .zen-exit {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 9999;
            display: none;
        }
        body.zen-mode .zen-exit { display: flex; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .stat-card {
            padding: 12px;
            background: var(--c-panel-alt);
            border-radius: var(--radius);
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--c-text);
        }
        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--c-text-muted);
            margin-top: 2px;
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--c-panel-alt);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--c-primary);
            border-radius: 2px;
            transition: width 0.3s;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: fixed;
            bottom: 50px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 50;
        }
        .zoom-btn {
            width: 32px;
            height: 32px;
            background: var(--c-panel);
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 12px;
            color: var(--c-text);
            transition: all 0.15s;
        }
        .zoom-btn:hover {
            background: var(--c-panel-alt);
            border-color: var(--c-border-strong);
        }

        /* File Drop */
        .file-drop-zone {
            border: 2px dashed var(--c-border);
            border-radius: var(--radius);
            padding: 30px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--c-primary);
            background: var(--c-primary-light);
        }
        .file-drop-zone i {
            font-size: 28px;
            color: var(--c-text-muted);
            margin-bottom: 10px;
        }

        /* Print */
        @media print {
            body { background: #fff; height: auto; overflow: visible; display: block; }
            header, #sidebar, footer, .modal-overlay, .toast-container, .zoom-controls, .zen-exit, .toolbar { display: none !important; }
            #workspace { padding: 0; background: #fff; display: block; overflow: visible; }
            .paper { box-shadow: none; margin: 0; width: 100%; border: none; page-break-after: always; }
            .paper:last-child { page-break-after: auto; }
            #editor-area { min-height: auto; }
            @page { size: A4; margin: 0; }
            #cover-page { page-break-after: always; border: none; }
        }

        /* Mobile */
        @media (max-width: 768px) {
            :root { --sidebar-width: 280px; }
            
            #sidebar {
                position: fixed;
                height: 100%;
                z-index: 200;
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }
            #sidebar.mobile-open { transform: translateX(0); }
            
            #mobile-menu-btn { display: flex !important; }
            .header-center { display: none; }
            .modal { max-width: 95%; }
        }
        
        #mobile-menu-btn { display: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: var(--c-border-strong); 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--c-text-muted); }

        /* Color Swatches */
        .color-picker-container {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .color-swatch {
            width: 22px;
            height: 22px;
            border: 2px solid var(--c-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.active { border-color: var(--c-primary); }

        /* Find & Replace */
        .find-replace-bar {
            background: var(--c-panel);
            border-bottom: 1px solid var(--c-border);
            padding: 8px 12px;
            display: none;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .find-replace-bar.open { display: flex; }
        .find-replace-bar input {
            padding: 6px 10px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius-sm);
            font-family: var(--font-ui);
            font-size: 12px;
            width: 160px;
        }
        .find-replace-bar input:focus {
            outline: none;
            border-color: var(--c-primary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <button class="btn btn-icon btn-ghost" id="mobile-menu-btn">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-pen-nib"></i></div>
            <span>Thesis</span>
        </div>
        
        <div class="header-center">
            <span style="font-size: 12px; color: var(--c-text-muted);" id="header-doc-name">Untitled Document</span>
        </div>
        
        <div class="header-actions">
            <button class="btn btn-icon btn-ghost" onclick="App.toggleZen()" title="Focus Mode (F11)">
                <i class="fas fa-expand"></i>
            </button>
            <button class="btn btn-primary btn-sm" onclick="App.openModal('export-modal')">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="btn btn-xs btn-primary" onclick="App.saveCurrent()">
                <i class="fas fa-save"></i> Save
            </button>
        </div>
        
        <div class="toolbar-group">
            <select class="toolbar-select" id="format-block" onchange="App.formatBlock(this.value)">
                <option value="p">Paragraph</option>
                <option value="h1">Heading 1</option>
                <option value="h2">Heading 2</option>
                <option value="h3">Heading 3</option>
            </select>
            <select class="toolbar-select" id="format-font" onchange="App.setFontFamily(this.value)">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Georgia">Georgia</option>
            </select>
            <select class="toolbar-select" id="format-size" onchange="App.setFontSize(this.value)">
                <option value="10pt">10pt</option>
                <option value="11pt">11pt</option>
                <option value="12pt" selected>12pt</option>
                <option value="14pt">14pt</option>
                <option value="16pt">16pt</option>
            </select>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.exec('bold')" title="Bold (Ctrl+B)"><i class="fas fa-bold"></i></button>
            <button class="toolbar-btn" onclick="App.exec('italic')" title="Italic (Ctrl+I)"><i class="fas fa-italic"></i></button>
            <button class="toolbar-btn" onclick="App.exec('underline')" title="Underline (Ctrl+U)"><i class="fas fa-underline"></i></button>
            <button class="toolbar-btn" onclick="App.exec('strikeThrough')" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.exec('subscript')" title="Subscript (x subscript)">
                <span style="font-size: 11px;">x<sub style="font-size: 8px;">sub</sub></span>
            </button>
            <button class="toolbar-btn" onclick="App.exec('superscript')" title="Superscript (x superscript)">
                <span style="font-size: 11px;">x<sup style="font-size: 8px;">sup</sup></span>
            </button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.exec('justifyLeft')" title="Align Left"><i class="fas fa-align-left"></i></button>
            <button class="toolbar-btn" onclick="App.exec('justifyCenter')" title="Align Center"><i class="fas fa-align-center"></i></button>
            <button class="toolbar-btn" onclick="App.exec('justifyRight')" title="Align Right"><i class="fas fa-align-right"></i></button>
            <button class="toolbar-btn" onclick="App.exec('justifyFull')" title="Justify"><i class="fas fa-align-justify"></i></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.exec('insertUnorderedList')" title="Bullet List"><i class="fas fa-list-ul"></i></button>
            <button class="toolbar-btn" onclick="App.exec('insertOrderedList')" title="Numbered List"><i class="fas fa-list-ol"></i></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.decreaseIndent()" title="Decrease Indent"><i class="fas fa-outdent"></i></button>
            <button class="toolbar-btn" onclick="App.increaseIndent()" title="Increase Indent"><i class="fas fa-indent"></i></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.insertImage()" title="Insert Image"><i class="fas fa-image"></i></button>
            <button class="toolbar-btn" onclick="App.insertTable()" title="Insert Table"><i class="fas fa-table"></i></button>
            <button class="toolbar-btn" onclick="App.insertLink()" title="Insert Link"><i class="fas fa-link"></i></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.openModal('ref-modal')" title="Insert Reference"><i class="fas fa-book"></i></button>
            <button class="toolbar-btn" onclick="App.insertPageBreak()" title="Insert Page Break"><i class="fas fa-file-alt"></i></button>
        </div>
        
        <div class="toolbar-group">
            <button class="toolbar-btn" onclick="App.toggleFindReplace()" title="Find & Replace (Ctrl+H)"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <!-- Find & Replace Bar -->
    <div class="find-replace-bar" id="find-replace-bar">
        <input type="text" id="find-input" placeholder="Find...">
        <input type="text" id="replace-input" placeholder="Replace with...">
        <button class="btn btn-xs" onclick="App.findNext()">Find</button>
        <button class="btn btn-xs" onclick="App.replaceNext()">Replace</button>
        <button class="btn btn-xs" onclick="App.replaceAll()">Replace All</button>
        <button class="btn btn-xs btn-ghost" onclick="App.toggleFindReplace()"><i class="fas fa-times"></i></button>
    </div>

    <div id="app-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Documents</div>
                <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    <button class="btn btn-xs btn-primary btn-full" onclick="App.newDocument()">
                        <i class="fas fa-plus"></i> New
                    </button>
                    <button class="btn btn-xs btn-full" onclick="App.saveCurrent()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
                <ul id="doc-list"></ul>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Formatting Standard</div>
                <button class="format-option active" data-style="abnt" onclick="App.setStandard('abnt')">
                    <div class="format-option-icon">AB</div>
                    <div class="format-option-info">
                        <div class="format-option-name">ABNT</div>
                        <div class="format-option-desc">NBR 14724 - Arial 12pt</div>
                    </div>
                </button>
                <button class="format-option" data-style="apa" onclick="App.setStandard('apa')">
                    <div class="format-option-icon">AP</div>
                    <div class="format-option-info">
                        <div class="format-option-name">APA</div>
                        <div class="format-option-desc">7th Edition - Times</div>
                    </div>
                </button>
                <button class="format-option" data-style="mla" onclick="App.setStandard('mla')">
                    <div class="format-option-icon">ML</div>
                    <div class="format-option-info">
                        <div class="format-option-name">MLA</div>
                        <div class="format-option-desc">9th Edition - Times</div>
                    </div>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Page Options</div>
                <button class="btn btn-sm btn-full" onclick="App.toggleCover()" id="btn-cover">
                    <i class="fas fa-file-alt"></i> <span id="cover-btn-text">Add Cover Page</span>
                </button>
                <button class="btn btn-sm btn-full" style="margin-top: 6px;" onclick="App.clearDocument()">
                    <i class="fas fa-trash-alt"></i> Clear Content
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Statistics</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-words">0</div>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-chars">0</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-pages">1</div>
                        <div class="stat-label">Pages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-time">0m</div>
                        <div class="stat-label">Read Time</div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <label style="font-size: 10px; font-weight: 500; color: var(--c-text-muted);">
                        Goal: <span id="goal-current">0</span> / <span id="goal-target">1000</span> words
                    </label>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="goal-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Settings</div>
                <div class="form-group" style="margin-bottom: 10px;">
                    <label>Theme</label>
                    <select class="form-input" id="setting-theme" onchange="App.setTheme(this.value)">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
            </div>
        </aside>

        <!-- Workspace -->
        <main id="workspace">
            <div class="pages-container">
                <div class="paper style-abnt" id="paper">
                    <div id="cover-page">
                        <h2 contenteditable="true" id="cover-inst" style="font-size: 14pt; font-weight: bold; margin-bottom: 20px;">INSTITUTION NAME</h2>
                        <h3 contenteditable="true" id="cover-author" style="font-size: 12pt; margin-bottom: 60px;">Author Name</h3>
                        <h1 contenteditable="true" id="cover-title" style="font-size: 16pt; font-weight: bold; max-width: 80%;">Title of the Academic Work</h1>
                        <div style="margin-top: 80px; text-align: center;">
                            <p contenteditable="true" style="margin: 4px 0;">City</p>
                            <p contenteditable="true" style="margin: 4px 0;">Year</p>
                        </div>
                    </div>
                    <div id="editor-area" contenteditable="true" spellcheck="true">
                        <h1>Introduction</h1>
                        <p>Welcome to Thesis - your professional academic writing suite. This editor supports ABNT, APA, and MLA formatting standards with proper export capabilities.</p>
                        <p>Use the toolbar above for quick formatting, or explore the sidebar for document management and statistics.</p>
                        <h2>Getting Started</h2>
                        <p>This editor includes proper formatting preservation when copying and pasting, PDF and Word export with academic standards, and many other tools for professional academic writing.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-section">
            <span class="footer-item" id="footer-doc">
                <i class="fas fa-file"></i> Unsaved Document
            </span>
            <span class="footer-item" id="footer-standard">
                <i class="fas fa-ruler"></i> ABNT
            </span>
        </div>
        <div class="footer-section">
            <span class="footer-item" id="footer-status">
                <i class="fas fa-check-circle" style="color: var(--c-accent);"></i> Ready
            </span>
        </div>
    </footer>

    <!-- Zoom Controls -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="App.zoomIn()" title="Zoom In"><i class="fas fa-plus"></i></button>
        <button class="zoom-btn" id="zoom-level" onclick="App.zoomReset()" title="Reset Zoom">100%</button>
        <button class="zoom-btn" onclick="App.zoomOut()" title="Zoom Out"><i class="fas fa-minus"></i></button>
    </div>

    <!-- Zen Exit Button -->
    <button class="btn btn-danger zen-exit" onclick="App.toggleZen()">
        <i class="fas fa-times"></i> Exit Focus Mode
    </button>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Context Menu -->
    <div class="context-menu hidden" id="context-menu">
        <div class="context-menu-item" onclick="App.exec('cut')"><i class="fas fa-cut"></i> Cut</div>
        <div class="context-menu-item" onclick="App.exec('copy')"><i class="fas fa-copy"></i> Copy</div>
        <div class="context-menu-item" onclick="App.exec('paste')"><i class="fas fa-paste"></i> Paste</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="App.exec('bold')"><i class="fas fa-bold"></i> Bold</div>
        <div class="context-menu-item" onclick="App.exec('italic')"><i class="fas fa-italic"></i> Italic</div>
        <div class="context-menu-item" onclick="App.exec('underline')"><i class="fas fa-underline"></i> Underline</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="App.insertLink()"><i class="fas fa-link"></i> Insert Link</div>
    </div>

    <!-- Save Modal -->
    <div class="modal-overlay hidden" id="save-modal">
        <div class="modal">
            <div class="modal-header">
                <span>Save Document</span>
                <button class="modal-close" onclick="App.closeModal('save-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Document Name</label>
                    <input type="text" class="form-input" id="save-name" placeholder="Enter document name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('save-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.saveDocument()">Save</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay hidden" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <span>Export Document</span>
                <button class="modal-close" onclick="App.closeModal('export-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="tabs">
                    <button class="tab active" onclick="App.switchTab('export', 'pdf')">PDF</button>
                    <button class="tab" onclick="App.switchTab('export', 'word')">Word</button>
                    <button class="tab" onclick="App.switchTab('export', 'html')">HTML</button>
                </div>
                <div style="padding: 20px;">
                    <div class="tab-content" id="export-tab-pdf">
                        <p style="font-size: 12px; color: var(--c-text-muted); margin-bottom: 16px;">
                            Export as PDF with proper academic formatting preserved.
                        </p>
                        <button class="btn btn-primary btn-full" onclick="App.exportPDF()">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </button>
                    </div>
                    <div class="tab-content hidden" id="export-tab-word">
                        <p style="font-size: 12px; color: var(--c-text-muted); margin-bottom: 16px;">
                            Export as Word document (.doc) compatible with Microsoft Word, Google Docs, and LibreOffice.
                        </p>
                        <button class="btn btn-primary btn-full" onclick="App.exportWord()">
                            <i class="fas fa-file-word"></i> Download Word
                        </button>
                    </div>
                    <div class="tab-content hidden" id="export-tab-html">
                        <p style="font-size: 12px; color: var(--c-text-muted); margin-bottom: 16px;">
                            Export as standalone HTML with all formatting preserved.
                        </p>
                        <button class="btn btn-primary btn-full" onclick="App.exportHTML()">
                            <i class="fas fa-file-code"></i> Download HTML
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reference Modal -->
    <div class="modal-overlay hidden" id="ref-modal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <span>Reference Generator</span>
                <button class="modal-close" onclick="App.closeModal('ref-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="tabs">
                    <button class="tab active" onclick="App.switchTab('ref', 'book')">Book</button>
                    <button class="tab" onclick="App.switchTab('ref', 'article')">Article</button>
                    <button class="tab" onclick="App.switchTab('ref', 'web')">Website</button>
                </div>
                <div style="padding: 20px;">
                    <div class="tab-content" id="ref-tab-book">
                        <div class="form-group">
                            <label>Authors (Surname, Name; separated by ;)</label>
                            <input type="text" class="form-input" id="ref-authors" placeholder="Silva, JoÃ£o; Santos, Maria">
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="form-input" id="ref-title" placeholder="Book Title">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Year</label>
                                <input type="text" class="form-input" id="ref-year" placeholder="2024">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Edition</label>
                                <input type="text" class="form-input" id="ref-edition" placeholder="1">
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label>City</label>
                                <input type="text" class="form-input" id="ref-city" placeholder="SÃ£o Paulo">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Publisher</label>
                                <input type="text" class="form-input" id="ref-publisher" placeholder="Publisher">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="ref-tab-article">
                        <div class="form-group">
                            <label>Authors</label>
                            <input type="text" class="form-input" id="ref-art-authors" placeholder="Silva, JoÃ£o">
                        </div>
                        <div class="form-group">
                            <label>Article Title</label>
                            <input type="text" class="form-input" id="ref-art-title" placeholder="Article Title">
                        </div>
                        <div class="form-group">
                            <label>Journal Name</label>
                            <input type="text" class="form-input" id="ref-art-journal" placeholder="Journal Name">
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Year</label>
                                <input type="text" class="form-input" id="ref-art-year" placeholder="2024">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Volume</label>
                                <input type="text" class="form-input" id="ref-art-volume" placeholder="1">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Pages</label>
                                <input type="text" class="form-input" id="ref-art-pages" placeholder="1-10">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content hidden" id="ref-tab-web">
                        <div class="form-group">
                            <label>Author</label>
                            <input type="text" class="form-input" id="ref-web-author" placeholder="Author or Organization">
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="form-input" id="ref-web-title" placeholder="Page Title">
                        </div>
                        <div class="form-group">
                            <label>Website Name</label>
                            <input type="text" class="form-input" id="ref-web-site" placeholder="Website Name">
                        </div>
                        <div class="form-group">
                            <label>URL</label>
                            <input type="text" class="form-input" id="ref-web-url" placeholder="https://example.com">
                        </div>
                        <div class="form-group">
                            <label>Access Date</label>
                            <input type="date" class="form-input" id="ref-web-date">
                        </div>
                    </div>
                    
                    <div style="background: var(--c-panel-alt); border-radius: var(--radius); padding: 12px; margin-top: 16px;">
                        <label style="font-size: 10px; font-weight: 500; color: var(--c-text-muted); margin-bottom: 8px; display: block;">PREVIEW</label>
                        <div id="ref-preview" style="font-size: 12px; line-height: 1.6; color: var(--c-text);"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('ref-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertReference()">
                    <i class="fas fa-plus"></i> Insert
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal-overlay hidden" id="image-modal">
        <div class="modal">
            <div class="modal-header">
                <span>Insert Image</span>
                <button class="modal-close" onclick="App.closeModal('image-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="tabs">
                    <button class="tab active" onclick="App.switchTab('image', 'upload')">Upload</button>
                    <button class="tab" onclick="App.switchTab('image', 'url')">URL</button>
                </div>
                <div style="padding: 20px;">
                    <div class="tab-content" id="image-tab-upload">
                        <div class="file-drop-zone" id="image-drop-zone" onclick="document.getElementById('image-file').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div style="font-weight: 500;">Click or drag image here</div>
                            <div style="font-size: 11px; color: var(--c-text-muted); margin-top: 4px;">PNG, JPG up to 5MB</div>
                            <input type="file" id="image-file" accept="image/*" style="display: none;" onchange="App.handleImageUpload(this)">
                        </div>
                    </div>
                    <div class="tab-content hidden" id="image-tab-url">
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="text" class="form-input" id="image-url" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label>Caption (optional)</label>
                        <input type="text" class="form-input" id="image-caption" placeholder="Figure 1: Description">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('image-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertImageConfirm()">Insert Image</button>
            </div>
        </div>
    </div>

    <!-- Table Modal -->
    <div class="modal-overlay hidden" id="table-modal">
        <div class="modal">
            <div class="modal-header">
                <span>Insert Table</span>
                <button class="modal-close" onclick="App.closeModal('table-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Rows</label>
                        <input type="number" class="form-input" id="table-rows" value="3" min="1" max="20">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Columns</label>
                        <input type="number" class="form-input" id="table-cols" value="3" min="1" max="10">
                    </div>
                </div>
                <div class="form-group">
                    <label>First Row as Header</label>
                    <select class="form-input" id="table-header">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Caption (optional)</label>
                    <input type="text" class="form-input" id="table-caption" placeholder="Table 1: Description">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('table-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertTableConfirm()">Insert Table</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal-overlay hidden" id="link-modal">
        <div class="modal">
            <div class="modal-header">
                <span>Insert Link</span>
                <button class="modal-close" onclick="App.closeModal('link-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>URL</label>
                    <input type="text" class="form-input" id="link-url" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label>Text (optional)</label>
                    <input type="text" class="form-input" id="link-text" placeholder="Link text">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('link-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertLinkConfirm()">Insert Link</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // THESIS - MAIN APPLICATION
        // ============================================
        
        class ThesisApp {
            constructor() {
                this.paper = document.getElementById('paper');
                this.editor = document.getElementById('editor-area');
                this.cover = document.getElementById('cover-page');
                this.currentStandard = 'abnt';
                this.currentDocId = null;
                this.documents = [];
                this.zoomLevel = 1;
                this.settings = { goal: 1000, theme: 'light' };
                this.pendingImageData = null;
                this.currentRefTab = 'book';
                this.hasUnsavedChanges = false;
            }

            init() {
                this.loadSettings();
                this.loadDocuments();
                this.bindEvents();
                this.updateStats();
                
                if (this.documents.length === 0) {
                    this.toast('Welcome to Thesis', 'info');
                }
            }

            // ============================================
            // EVENT BINDING
            // ============================================
            
            bindEvents() {
                // Editor events
                this.editor.addEventListener('input', () => {
                    this.updateStats();
                    this.hasUnsavedChanges = true;
                    this.updateStatus('Editing...');
                });

                // Improved paste handler - preserves formatting
                this.editor.addEventListener('paste', (e) => this.handlePaste(e));

                // Handle blockquote exit
                this.editor.addEventListener('keydown', (e) => this.handleEditorKeydown(e));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));

                // Context menu
                this.editor.addEventListener('contextmenu', (e) => this.showContextMenu(e));
                document.addEventListener('click', () => this.hideContextMenu());

                // Mobile menu
                document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('mobile-open');
                });

                // Close modals on overlay click
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            this.closeModal(overlay.id);
                        }
                    });
                });

                // Image drag and drop
                const dropZone = document.getElementById('image-drop-zone');
                if (dropZone) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('dragover');
                    });
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('dragover');
                    });
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');
                        const file = e.dataTransfer.files[0];
                        if (file && file.type.startsWith('image/')) {
                            this.processImageFile(file);
                        }
                    });
                }

                // Reference preview update
                ['ref-tab-book', 'ref-tab-article', 'ref-tab-web'].forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        tab.addEventListener('input', () => this.updateRefPreview());
                    }
                });
            }

            handleEditorKeydown(e) {
                // Exit blockquote with Enter twice
                if (e.key === 'Enter') {
                    const sel = window.getSelection();
                    if (sel.rangeCount) {
                        let node = sel.anchorNode;
                        while (node && node !== this.editor) {
                            if (node.nodeName === 'BLOCKQUOTE') {
                                const range = sel.getRangeAt(0);
                                if (range.collapsed && range.startOffset === 0) {
                                    // Already at start of blockquote, let it exit
                                }
                                break;
                            }
                            node = node.parentNode;
                        }
                    }
                }
                
                // Tab to exit blockquote
                if (e.key === 'Tab') {
                    const sel = window.getSelection();
                    if (sel.rangeCount) {
                        let node = sel.anchorNode;
                        while (node && node !== this.editor) {
                            if (node.nodeName === 'BLOCKQUOTE') {
                                e.preventDefault();
                                // Move cursor outside blockquote
                                const range = sel.getRangeAt(0);
                                range.setStartAfter(node);
                                range.collapse(true);
                                sel.removeAllRanges();
                                sel.addRange(range);
                                this.toast('Exited quote', 'info');
                                return;
                            }
                            node = node.parentNode;
                        }
                    }
                }
            }

            handleKeyboard(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 's':
                            e.preventDefault();
                            this.saveCurrent();
                            break;
                        case 'b':
                            e.preventDefault();
                            this.exec('bold');
                            break;
                        case 'i':
                            e.preventDefault();
                            this.exec('italic');
                            break;
                        case 'u':
                            e.preventDefault();
                            this.exec('underline');
                            break;
                        case 'h':
                            e.preventDefault();
                            this.toggleFindReplace();
                            break;
                    }
                }

                if (e.key === 'F11') {
                    e.preventDefault();
                    this.toggleZen();
                }

                if (e.key === 'Escape') {
                    const visibleModal = document.querySelector('.modal-overlay:not(.hidden)');
                    if (visibleModal) {
                        this.closeModal(visibleModal.id);
                    }
                    if (document.body.classList.contains('zen-mode')) {
                        this.toggleZen();
                    }
                    // Close find bar
                    document.getElementById('find-replace-bar').classList.remove('open');
                }
            }

            handlePaste(e) {
                // Check for image paste
                const items = e.clipboardData?.items;
                if (items) {
                    for (let item of items) {
                        if (item.type.startsWith('image/')) {
                            e.preventDefault();
                            const file = item.getAsFile();
                            this.processImageFile(file);
                            return;
                        }
                    }
                }

                // For text, let browser handle it naturally to preserve formatting
                // This fixes the "text not formatted when copy/paste" issue
            }

            // ============================================
            // DOCUMENT MANAGEMENT
            // ============================================

            loadDocuments() {
                try {
                    const saved = localStorage.getItem('thesis_documents');
                    this.documents = saved ? JSON.parse(saved) : [];
                } catch (e) {
                    this.documents = [];
                }
                this.renderDocList();
            }

            saveToStorage() {
                localStorage.setItem('thesis_documents', JSON.stringify(this.documents));
            }

            renderDocList() {
                const list = document.getElementById('doc-list');
                list.innerHTML = '';

                this.documents.forEach(doc => {
                    const li = document.createElement('li');
                    li.className = `doc-item ${this.currentDocId === doc.id ? 'active' : ''}`;
                    
                    li.innerHTML = `
                        <i class="fas fa-file-alt doc-item-icon"></i>
                        <div class="doc-item-info">
                            <div class="doc-item-name">${this.escapeHtml(doc.name)}</div>
                            <div class="doc-item-date">${this.formatDate(doc.updatedAt)}</div>
                        </div>
                        <div class="doc-item-actions">
                            <button class="doc-item-btn" onclick="event.stopPropagation(); App.deleteDocument(${doc.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    li.addEventListener('click', () => this.loadDocument(doc.id));
                    list.appendChild(li);
                });
            }

            newDocument() {
                this.currentDocId = null;
                this.editor.innerHTML = '<h1>Title</h1><p>Start writing your document...</p>';
                this.cover.style.display = 'none';
                document.getElementById('cover-btn-text').textContent = 'Add Cover Page';
                this.updateFooterDoc('Untitled Document');
                document.getElementById('header-doc-name').textContent = 'Untitled Document';
                this.renderDocList();
                this.toast('New document created', 'success');
            }

            saveCurrent() {
                if (this.currentDocId) {
                    this.updateDocument();
                } else {
                    document.getElementById('save-name').value = '';
                    this.openModal('save-modal');
                }
            }

            saveDocument() {
                const nameInput = document.getElementById('save-name');
                const name = nameInput.value.trim() || 'Untitled Document';

                const doc = {
                    id: Date.now(),
                    name: name,
                    content: this.editor.innerHTML,
                    cover: this.cover.style.display !== 'none' ? this.cover.innerHTML : null,
                    standard: this.currentStandard,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                this.documents.unshift(doc);
                this.currentDocId = doc.id;
                this.hasUnsavedChanges = false;
                this.saveToStorage();
                this.renderDocList();
                this.closeModal('save-modal');
                this.updateFooterDoc(name);
                document.getElementById('header-doc-name').textContent = name;
                this.toast('Document saved', 'success');
            }

            updateDocument() {
                const doc = this.documents.find(d => d.id === this.currentDocId);
                if (doc) {
                    doc.content = this.editor.innerHTML;
                    doc.cover = this.cover.style.display !== 'none' ? this.cover.innerHTML : null;
                    doc.standard = this.currentStandard;
                    doc.updatedAt = new Date().toISOString();
                    this.hasUnsavedChanges = false;
                    this.saveToStorage();
                    this.renderDocList();
                    this.toast('Document saved', 'success');
                }
            }

            loadDocument(id) {
                const doc = this.documents.find(d => d.id === id);
                if (!doc) return;

                this.editor.innerHTML = doc.content || '<p>Empty document</p>';
                if (doc.cover) {
                    this.cover.innerHTML = doc.cover;
                    this.cover.style.display = 'flex';
                    document.getElementById('cover-btn-text').textContent = 'Remove Cover';
                } else {
                    this.cover.style.display = 'none';
                    document.getElementById('cover-btn-text').textContent = 'Add Cover Page';
                }

                this.currentDocId = id;
                this.setStandard(doc.standard);
                this.renderDocList();
                this.updateStats();
                this.updateFooterDoc(doc.name);
                document.getElementById('header-doc-name').textContent = doc.name;
                this.toast(`Loaded: ${doc.name}`, 'success');

                document.getElementById('sidebar').classList.remove('mobile-open');
            }

            deleteDocument(id) {
                if (!confirm('Delete this document?')) return;

                this.documents = this.documents.filter(d => d.id !== id);
                if (this.currentDocId === id) {
                    this.newDocument();
                }
                this.saveToStorage();
                this.renderDocList();
                this.toast('Document deleted', 'info');
            }

            clearDocument() {
                if (!confirm('Clear all content?')) return;
                this.editor.innerHTML = '<p>Start writing...</p>';
                this.updateStats();
                this.toast('Content cleared', 'info');
            }

            // ============================================
            // EDITOR COMMANDS
            // ============================================

            exec(command, value = null) {
                document.execCommand(command, false, value);
                this.editor.focus();
            }

            formatBlock(tag) {
                document.execCommand('formatBlock', false, `<${tag}>`);
                this.editor.focus();
            }

            setFontFamily(font) {
                document.execCommand('fontName', false, font);
                this.editor.focus();
            }

            setFontSize(size) {
                // Use CSS for font size since execCommand fontSize uses 1-7 scale
                const selection = window.getSelection();
                if (selection.rangeCount && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontSize = size;
                    range.surroundContents(span);
                }
                this.editor.focus();
            }

            increaseIndent() {
                document.execCommand('indent', false, null);
            }

            decreaseIndent() {
                document.execCommand('outdent', false, null);
            }

            setStandard(standard) {
                this.currentStandard = standard;
                
                document.querySelectorAll('.format-option').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.style === standard);
                });
                
                this.paper.className = `paper style-${standard}`;
                
                document.getElementById('footer-standard').innerHTML = `<i class="fas fa-ruler"></i> ${standard.toUpperCase()}`;
            }

            toggleCover() {
                const isHidden = this.cover.style.display === 'none';
                this.cover.style.display = isHidden ? 'flex' : 'none';
                document.getElementById('cover-btn-text').textContent = isHidden ? 'Remove Cover' : 'Add Cover Page';
            }

            // ============================================
            // INSERT FUNCTIONS
            // ============================================

            insertImage() {
                this.pendingImageData = null;
                document.getElementById('image-url').value = '';
                document.getElementById('image-caption').value = '';
                document.getElementById('image-file').value = '';
                this.openModal('image-modal');
            }

            handleImageUpload(input) {
                const file = input.files[0];
                if (file) {
                    this.processImageFile(file);
                }
            }

            processImageFile(file) {
                if (file.size > 5 * 1024 * 1024) {
                    this.toast('Image too large (max 5MB)', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.pendingImageData = e.target.result;
                    this.toast('Image ready to insert', 'success');
                };
                reader.readAsDataURL(file);
            }

            insertImageConfirm() {
                const url = this.pendingImageData || document.getElementById('image-url').value.trim();
                const caption = document.getElementById('image-caption').value.trim();

                if (!url) {
                    this.toast('Please provide an image', 'error');
                    return;
                }

                const figure = document.createElement('figure');
                figure.style.textAlign = 'center';

                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '100%';
                img.alt = caption || 'Image';
                figure.appendChild(img);

                if (caption) {
                    const figcaption = document.createElement('figcaption');
                    figcaption.textContent = caption;
                    figure.appendChild(figcaption);
                }

                this.insertNodeAtCursor(figure);
                this.closeModal('image-modal');
                this.toast('Image inserted', 'success');
            }

            insertTable() {
                this.openModal('table-modal');
            }

            insertTableConfirm() {
                const rows = parseInt(document.getElementById('table-rows').value) || 3;
                const cols = parseInt(document.getElementById('table-cols').value) || 3;
                const hasHeader = document.getElementById('table-header').value === 'yes';
                const caption = document.getElementById('table-caption').value.trim();

                const table = document.createElement('table');
                table.style.width = '100%';

                for (let i = 0; i < rows; i++) {
                    const tr = document.createElement('tr');
                    for (let j = 0; j < cols; j++) {
                        const cell = document.createElement(i === 0 && hasHeader ? 'th' : 'td');
                        cell.textContent = i === 0 && hasHeader ? `Header ${j + 1}` : '';
                        tr.appendChild(cell);
                    }
                    table.appendChild(tr);
                }

                if (caption) {
                    const fig = document.createElement('figure');
                    const figcaption = document.createElement('figcaption');
                    figcaption.textContent = caption;
                    fig.appendChild(table);
                    fig.appendChild(figcaption);
                    this.insertNodeAtCursor(fig);
                } else {
                    this.insertNodeAtCursor(table);
                }

                this.closeModal('table-modal');
                this.toast('Table inserted', 'success');
            }

            insertLink() {
                const selection = window.getSelection();
                const selectedText = selection.toString();
                document.getElementById('link-text').value = selectedText;
                document.getElementById('link-url').value = '';
                this.openModal('link-modal');
            }

            insertLinkConfirm() {
                const url = document.getElementById('link-url').value.trim();
                const text = document.getElementById('link-text').value.trim() || url;

                if (!url) {
                    this.toast('Please enter a URL', 'error');
                    return;
                }

                const a = document.createElement('a');
                a.href = url;
                a.textContent = text;
                a.target = '_blank';
                
                this.insertNodeAtCursor(a);
                this.closeModal('link-modal');
                this.toast('Link inserted', 'success');
            }

            insertPageBreak() {
                const div = document.createElement('div');
                div.className = 'page-break';
                this.insertNodeAtCursor(div);
                this.toast('Page break inserted', 'success');
            }

            insertNodeAtCursor(node) {
                const selection = window.getSelection();
                if (selection.rangeCount) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(node);
                    range.setStartAfter(node);
                    range.setEndAfter(node);
                    selection.removeAllRanges();
                    selection.addRange(range);
                } else {
                    this.editor.appendChild(node);
                }
                this.editor.focus();
            }

            // ============================================
            // REFERENCE GENERATOR
            // ============================================

            updateRefPreview() {
                const preview = document.getElementById('ref-preview');
                if (!preview) return;

                let ref = '';

                if (this.currentRefTab === 'book') {
                    const authors = document.getElementById('ref-authors')?.value || '';
                    const title = document.getElementById('ref-title')?.value || '';
                    const year = document.getElementById('ref-year')?.value || '';
                    const edition = document.getElementById('ref-edition')?.value || '';
                    const city = document.getElementById('ref-city')?.value || '';
                    const publisher = document.getElementById('ref-publisher')?.value || '';

                    if (this.currentStandard === 'abnt') {
                        ref = `${authors}. <b>${title}</b>. ${edition ? edition + '. ed. ' : ''}${city}: ${publisher}, ${year}.`;
                    } else if (this.currentStandard === 'apa') {
                        ref = `${authors} (${year}). <i>${title}</i>. ${edition ? `(${edition}th ed.) ` : ''}${publisher}.`;
                    } else {
                        ref = `${authors}. <i>${title}</i>. ${publisher}, ${year}.`;
                    }
                } else if (this.currentRefTab === 'article') {
                    const authors = document.getElementById('ref-art-authors')?.value || '';
                    const title = document.getElementById('ref-art-title')?.value || '';
                    const journal = document.getElementById('ref-art-journal')?.value || '';
                    const year = document.getElementById('ref-art-year')?.value || '';
                    const volume = document.getElementById('ref-art-volume')?.value || '';
                    const pages = document.getElementById('ref-art-pages')?.value || '';

                    if (this.currentStandard === 'abnt') {
                        ref = `${authors}. ${title}. <b>${journal}</b>, v. ${volume}, p. ${pages}, ${year}.`;
                    } else {
                        ref = `${authors} (${year}). ${title}. <i>${journal}</i>, <i>${volume}</i>, ${pages}.`;
                    }
                } else if (this.currentRefTab === 'web') {
                    const author = document.getElementById('ref-web-author')?.value || '';
                    const title = document.getElementById('ref-web-title')?.value || '';
                    const site = document.getElementById('ref-web-site')?.value || '';
                    const url = document.getElementById('ref-web-url')?.value || '';
                    const date = document.getElementById('ref-web-date')?.value || '';

                    if (this.currentStandard === 'abnt') {
                        ref = `${author}. ${title}. ${site}, ${date ? new Date(date).toLocaleDateString('pt-BR') : 's.d.'}. Available at: ${url}. Accessed: ${new Date().toLocaleDateString('pt-BR')}.`;
                    } else {
                        ref = `${author} (${date ? new Date(date).getFullYear() : 'n.d.'}). <i>${title}</i>. ${site}. Retrieved from ${url}`;
                    }
                }

                preview.innerHTML = ref || 'Fill in the fields to see preview...';
            }

            insertReference() {
                const preview = document.getElementById('ref-preview');
                const p = document.createElement('p');
                p.innerHTML = preview.innerHTML;
                p.style.marginBottom = '6pt';
                p.style.textIndent = '0';
                
                this.insertNodeAtCursor(p);
                this.closeModal('ref-modal');
                this.toast('Reference inserted', 'success');
            }

            // ============================================
            // FIND & REPLACE
            // ============================================

            toggleFindReplace() {
                const bar = document.getElementById('find-replace-bar');
                bar.classList.toggle('open');
                if (bar.classList.contains('open')) {
                    document.getElementById('find-input').focus();
                }
            }

            findNext() {
                const searchText = document.getElementById('find-input').value;
                if (!searchText) return;

                const content = this.editor.textContent;
                const index = content.indexOf(searchText);
                
                if (index >= 0) {
                    this.toast(`Found: "${searchText}"`, 'info');
                } else {
                    this.toast('Not found', 'info');
                }
            }

            replaceNext() {
                const searchText = document.getElementById('find-input').value;
                const replaceText = document.getElementById('replace-input').value;
                if (!searchText) return;

                document.execCommand('insertText', false, replaceText);
            }

            replaceAll() {
                const searchText = document.getElementById('find-input').value;
                const replaceText = document.getElementById('replace-input').value;
                if (!searchText) return;

                const content = this.editor.innerHTML;
                const newContent = content.split(searchText).join(replaceText);
                this.editor.innerHTML = newContent;
                this.toast('All replaced', 'success');
            }

            // ============================================
            // EXPORT FUNCTIONS
            // ============================================

            exportPDF() {
                this.toast('Generating PDF...', 'info');
                
                // Clone and prepare content
                const clone = this.paper.cloneNode(true);
                
                // Remove cover if hidden
                const coverEl = clone.querySelector('#cover-page');
                if (coverEl && getComputedStyle(coverEl).display === 'none') {
                    coverEl.remove();
                }

                // Remove page break text
                clone.querySelectorAll('.page-break').forEach(pb => {
                    pb.innerHTML = '';
                    pb.style.borderTop = 'none';
                });

                const opt = {
                    margin: 0,
                    filename: `thesis-document-${Date.now()}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                html2pdf().set(opt).from(clone).save().then(() => {
                    this.toast('PDF downloaded', 'success');
                    this.closeModal('export-modal');
                }).catch(err => {
                    console.error(err);
                    this.toast('Error generating PDF', 'error');
                });
            }

            exportWord() {
                const content = this.generateExportHTML();
                const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `thesis-document-${Date.now()}.doc`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.toast('Word document downloaded', 'success');
                this.closeModal('export-modal');
            }

            exportHTML() {
                const content = this.generateExportHTML();
                const blob = new Blob([content], { type: 'text/html' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `thesis-document-${Date.now()}.html`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.toast('HTML downloaded', 'success');
                this.closeModal('export-modal');
            }

            generateExportHTML() {
                // Get proper styles based on standard
                let styleRules = '';
                const computedStyle = getComputedStyle(this.editor);
                
                if (this.currentStandard === 'abnt') {
                    styleRules = `
                        body { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5; text-align: justify; padding: 3cm 2cm 2cm 3cm; }
                        h1 { font-size: 14pt; text-align: center; font-weight: bold; margin: 24px 0 12px; }
                        h2 { font-size: 12pt; font-weight: bold; margin: 12px 0; }
                        p { text-indent: 1.25cm; margin-bottom: 0; }
                        blockquote { border-left: 3px solid #2563eb; padding-left: 16px; margin: 16px 0; background: #f8fafc; }
                    `;
                } else if (this.currentStandard === 'apa') {
                    styleRules = `
                        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 2; padding: 1in; }
                        h1 { font-size: 12pt; text-align: center; font-weight: bold; margin: 12px 0; }
                        p { text-indent: 0.5in; margin-bottom: 0; }
                    `;
                } else {
                    styleRules = `
                        body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 2; padding: 1in; }
                        h1 { font-size: 14pt; text-align: center; margin: 12px 0; }
                        p { text-indent: 0.5in; }
                    `;
                }

                return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Thesis Document</title>
    <style>
        ${styleRules}
        table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        td, th { border: 1px solid #000; padding: 8px; }
        th { background: #f5f5f5; font-weight: bold; }
        figure { margin: 16px 0; text-align: center; }
        figcaption { font-size: 10pt; color: #666; margin-top: 8px; }
        img { max-width: 100%; }
    </style>
</head>
<body>
 ${this.cover.style.display !== 'none' ? this.cover.outerHTML : ''}
 ${this.editor.innerHTML}
</body>
</html>`;
            }

            // ============================================
            // ZOOM
            // ============================================

            zoomIn() {
                this.zoomLevel = Math.min(1.5, this.zoomLevel + 0.1);
                this.applyZoom();
            }

            zoomOut() {
                this.zoomLevel = Math.max(0.5, this.zoomLevel - 0.1);
                this.applyZoom();
            }

            zoomReset() {
                this.zoomLevel = 1;
                this.applyZoom();
            }

            applyZoom() {
                this.paper.style.transform = `scale(${this.zoomLevel})`;
                document.getElementById('zoom-level').textContent = Math.round(this.zoomLevel * 100) + '%';
            }

            // ============================================
            // ZEN MODE
            // ============================================

            toggleZen() {
                document.body.classList.toggle('zen-mode');
                const isActive = document.body.classList.contains('zen-mode');
                this.toast(isActive ? 'Focus mode on' : 'Focus mode off', 'info');
            }

            // ============================================
            // CONTEXT MENU
            // ============================================

            showContextMenu(e) {
                e.preventDefault();
                const menu = document.getElementById('context-menu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.classList.remove('hidden');
            }

            hideContextMenu() {
                document.getElementById('context-menu').classList.add('hidden');
            }

            // ============================================
            // STATISTICS
            // ============================================

            updateStats() {
                const text = this.editor.innerText || '';
                const words = text.trim().split(/\s+/).filter(w => w.length > 0 && /[\w\u00C0-\u00FF]/.test(w)).length;
                const chars = text.length;
                const pages = Math.max(1, Math.ceil(words / 300));
                const readTime = Math.max(1, Math.ceil(words / 200));

                document.getElementById('stat-words').textContent = words.toLocaleString();
                document.getElementById('stat-chars').textContent = chars.toLocaleString();
                document.getElementById('stat-pages').textContent = pages;
                document.getElementById('stat-time').textContent = readTime + 'm';

                const goal = this.settings.goal || 1000;
                const progress = Math.min(100, (words / goal) * 100);
                document.getElementById('goal-current').textContent = words;
                document.getElementById('goal-target').textContent = goal;
                document.getElementById('goal-progress').style.width = progress + '%';
            }

            updateStatus(text) {
                document.getElementById('footer-status').innerHTML = `<i class="fas fa-pen"></i> ${text}`;
            }

            // ============================================
            // SETTINGS
            // ============================================

            loadSettings() {
                try {
                    const saved = localStorage.getItem('thesis_settings');
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                } catch (e) {}

                if (this.settings.theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    document.getElementById('setting-theme').value = 'dark';
                }
            }

            setTheme(theme) {
                this.settings.theme = theme;
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                localStorage.setItem('thesis_settings', JSON.stringify(this.settings));
            }

            // ============================================
            // MODAL FUNCTIONS
            // ============================================

            openModal(id) {
                document.getElementById(id)?.classList.remove('hidden');
            }

            closeModal(id) {
                document.getElementById(id)?.classList.add('hidden');
            }

            switchTab(context, tab) {
                this.currentRefTab = tab;
                
                document.querySelectorAll(`[onclick*="App.switchTab('${context}'"]`).forEach(btn => {
                    btn.classList.toggle('active', btn.textContent.toLowerCase() === tab);
                });

                document.querySelectorAll(`[id^="${context}-tab-"]`).forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${context}-tab-${tab}`)?.classList.remove('hidden');

                if (context === 'ref') {
                    this.updateRefPreview();
                }
            }

            // ============================================
            // UTILITIES
            // ============================================

            toast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
                toast.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i> ${message}`;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(10px)';
                    setTimeout(() => toast.remove(), 300);
                }, 2500);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: 'short', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            updateFooterDoc(name) {
                document.getElementById('footer-doc').innerHTML = `<i class="fas fa-file"></i> ${this.escapeHtml(name)}`;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            window.App = new ThesisApp();
            window.App.init();
        });
    </script>
</body>
</html>
