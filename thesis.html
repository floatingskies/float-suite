<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thesis.web - Academic Suite</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#FFDE59">
    <meta name="description" content="ABNT, APA, MLA Academic Editor">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* =========================================
           NEO-BRUTALIST THEME
           ========================================= */
        :root {
            /* Palette */
            --c-bg: #e0e0e0;
            --c-panel: #ffffff;
            --c-border: #000000;
            --c-text: #000000;
            
            /* Accents */
            --c-primary: #FFDE59;   /* Acid Yellow */
            --c-secondary: #FF90E8; /* Hot Pink */
            --c-accent: #23C9FF;    /* Cyan */
            --c-success: #00E096;   /* Green */
            --c-danger: #FF5C5C;    /* Red */
            
            /* Structural */
            --border-width: 3px;
            --shadow-hard: 4px 4px 0px var(--c-border);
            --shadow-active: 2px 2px 0px var(--c-border);
            
            --font-ui: 'Courier New', Courier, monospace;
        }

        [data-theme="dark"] {
            --c-bg: #121212;
            --c-panel: #1e1e1e;
            --c-text: #ffffff;
            --c-border: #ffffff;
            --c-primary: #bfa300;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* =========================================
           UI COMPONENTS
           ========================================= */
        .btn {
            background: var(--c-panel);
            border: var(--border-width) solid var(--c-border);
            box-shadow: 2px 2px 0px var(--c-border);
            padding: 8px 12px;
            font-family: var(--font-ui);
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.05s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            font-size: 11px;
            color: #000;
        }
        .btn:hover { 
            background: var(--c-primary); 
            transform: translate(-1px, -1px); 
            box-shadow: 3px 3px 0px var(--c-border); 
        }
        .btn:active, .btn.active { 
            background: var(--c-secondary); 
            transform: translate(2px, 2px); 
            box-shadow: 0px 0px 0px var(--c-border); 
        }
        
        .btn-primary { background: var(--c-primary); }
        .btn-secondary { background: var(--c-secondary); }
        .btn-danger { background: var(--c-danger); color: #fff; }
        .btn-danger:hover { background: #ff3333; color: #fff; }
        
        .btn-sm { padding: 4px 8px; font-size: 10px; }
        .btn-icon { width: 34px; height: 34px; padding: 0; }

        .panel {
            background: var(--c-panel);
            border: var(--border-width) solid var(--c-border);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        /* =========================================
           LAYOUT
           ========================================= */
        header {
            height: 50px;
            border-bottom: var(--border-width) solid var(--c-border);
            background: var(--c-primary);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            z-index: 20;
            flex-shrink: 0;
        }
        .logo { font-size: 18px; font-weight: 900; letter-spacing: -1px; display: flex; align-items: center; gap: 8px;}

        #app-container {
            display: flex; flex: 1; overflow: hidden; position: relative;
        }

        /* SIDEBAR */
        #sidebar {
            width: 300px;
            border-right: var(--border-width) solid var(--c-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .sidebar-section { padding: 15px; border-bottom: 2px solid var(--c-border); }
        .sidebar-title { font-weight: 900; margin-bottom: 10px; display: block; font-size: 13px; text-transform: uppercase; }

        .format-option {
            display: flex; align-items: center; width: 100%; text-align: left;
            margin-bottom: 8px; padding: 8px;
            border: 2px solid var(--c-border);
            cursor: pointer;
            background: #fff;
            font-weight: bold; font-size: 12px;
            transition: 0.1s;
        }
        .format-option:hover { background: #eee; }
        .format-option.active { background: var(--c-accent); color: #fff; border-color: #000; box-shadow: 2px 2px 0 #000; }

        /* CHECKLIST STYLES */
        .checklist-item {
            display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; font-weight: bold;
            cursor: pointer;
        }
        .checklist-item input { width: 16px; height: 16px; margin-right: 10px; accent-color: var(--c-success); cursor: pointer;}
        
        /* WORKSPACE */
        #workspace {
            flex: 1;
            background-color: #bbb;
            /* Graph paper grid pattern */
            background-image: linear-gradient(var(--c-border) 1px, transparent 1px), linear-gradient(90deg, var(--c-border) 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #e0e0e0;
            overflow: auto;
            padding: 40px;
            display: flex; justify-content: center;
        }

        /* THE PAPER SHEET */
        #paper {
            width: 210mm; /* A4 Width */
            min-height: 297mm; /* A4 Height */
            background: white;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: 40px;
        }

        /* EDITOR AREA */
        #editor-area {
            flex: 1;
            outline: none;
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 0;
        }

        /* Cover Page */
        #cover-page {
            min-height: 297mm;
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            page-break-after: always;
            border-bottom: 1px solid #ddd; /* Visual separator in editor only */
            padding-bottom: 20px;
        }

        /* Formatting Toolbar (Grid) */
        .toolbar-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px;
        }

        /* FOOTER */
        footer {
            height: 30px; background: var(--c-panel); border-top: var(--border-width) solid var(--c-border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 11px;
            font-weight: bold; flex-shrink: 0;
        }

        /* =========================================
           ACADEMIC STYLES (Applied to #paper)
           ========================================= */
        
        /* ABNT (Brazil - NBR 14724) */
        .style-abnt {
            font-family: Arial, sans-serif;
            color: black;
            /* Margins handled in @media print, set for preview here loosely */
            padding: 30px; 
        }
        /* Apply to children paragraphs */
        .style-abnt #editor-area, .style-abnt p, .style-abnt li {
            font-size: 12pt;
            line-height: 1.5;
            text-align: justify;
            margin-bottom: 0; 
            text-indent: 1.25cm;
        }
        .style-abnt h1 { font-size: 14pt; font-weight: bold; text-align: center; margin: 20px 0 10px 0; text-indent: 0; }
        .style-abnt h2 { font-size: 12pt; font-weight: bold; text-align: left; margin: 10px 0; text-indent: 0; }
        .style-abnt #cover-page h1 { font-size: 16pt; margin-bottom: 40px; }
        .style-abnt #cover-page h2 { font-size: 14pt; font-weight: bold; text-transform: uppercase; margin-bottom: 120px; }

        /* APA (US/Canada - 7th Ed) */
        .style-apa {
            font-family: 'Times New Roman', serif;
            padding: 30px;
        }
        .style-apa #editor-area, .style-apa p, .style-apa li {
            font-size: 12pt;
            line-height: 2; /* Double spacing */
            text-align: left;
            margin-bottom: 0; /* APA double space applies to gap between paras too usually, but cleaner css uses margins */
        }
        .style-apa p { margin-bottom: 12px; text-indent: 0.5in; } 
        .style-apa p:first-of-type { text-indent: 0; }
        .style-apa h1 { font-size: 12pt; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .style-apa #cover-page h2 { font-size: 14pt; margin-bottom: 40px; }
        
        /* MLA (Humanities - 9th Ed) */
        .style-mla {
            font-family: 'Times New Roman', serif;
            padding: 30px;
        }
        .style-mla #editor-area, .style-mla p {
            font-size: 12pt;
            line-height: 1;
            text-align: left;
            margin-bottom: 10px;
        }
        .style-mla h1 { font-size: 14pt; font-weight: bold; text-align: left; margin-bottom: 5px; }

        /* Helper: Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.hidden { display: none; }
        .modal-content {
            background: var(--c-panel); border: var(--border-width) solid var(--c-border);
            width: 90%; max-width: 500px;
            padding: 20px;
            box-shadow: 10px 10px 0px #000;
            display: flex; flex-direction: column; gap: 10px;
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from {transform: translateY(20px); opacity:0;} to {transform: translateY(0); opacity:1;} }
        
        .modal-header { font-size: 18px; font-weight: 900; margin-bottom: 10px; border-bottom: 3px solid #000; padding-bottom: 10px;}
        
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 8px; border: 2px solid #000; font-family: var(--font-ui);
            background: var(--c-bg);
            font-size: 13px;
        }
        .form-group textarea { height: 60px; resize: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* Toast */
        .toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: var(--c-success); color: #000;
            padding: 10px 20px; border: 2px solid #000;
            box-shadow: 4px 4px 0px #000;
            font-weight: bold; z-index: 2000;
            animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popUp { from {transform: translate(-50%, 100%); opacity: 0;} to {transform: translate(-50%, 0); opacity: 1;} }

        /* Focus Mode (Zen Mode) */
        body.focus-mode #sidebar, body.focus-mode header, body.focus-mode footer, body.focus-mode .modal-overlay, body.focus-mode .toast, body.focus-mode .toolbar-grid, body.focus-mode #zen-toggle {
            display: none;
        }
        body.focus-mode #workspace { padding: 0; background: #888; }
        body.focus-mode #paper { box-shadow: none; margin: 40px auto; width: 210mm; }
        #zen-toggle { position: fixed; top: 60px; right: 20px; z-index: 100; display: none; }
        body.focus-mode #zen-toggle { display: block; }

        /* =========================================
           PRINT / PDF ENGINE
           ========================================= */
        @media print {
            /* Hide UI */
            body { background: white; height: auto; overflow: visible; display: block; }
            header, #sidebar, footer, .modal-overlay, .toast, .toolbar-grid, #zen-toggle, #mobile-menu-btn { display: none !important; }
            
            /* Show only paper content */
            #workspace { padding: 0; background: white; display: block; overflow: visible; }
            #paper {
                box-shadow: none; margin: 0; width: 100%; padding: 0; min-height: auto;
                page-break-after: auto;
                border: none;
            }

            /* FORCE PAGE MARGINS */
            @page {
                size: A4;
                margin: 0; /* We handle margins inside #paper to avoid browser double margins */
            }
            
            /* ABNT Margins (3cm Left/Top, 2cm Right/Bottom) */
            .style-abnt #paper-wrapper, .style-abnt {
                padding: 3cm 2cm 2cm 3cm !important;
                width: 100% !important;
            }

            /* APA Margins (1 inch) */
            .style-apa #paper-wrapper, .style-apa {
                padding: 1in !important;
                width: 100% !important;
            }
            
            /* MLA Margins (1 inch) */
            .style-mla #paper-wrapper, .style-mla {
                padding: 1in !important;
                width: 100% !important;
            }
            
            /* Ensure Cover Page breaks correctly */
            #cover-page { page-break-after: always; border: none; min-height: auto; padding-top: 3cm;}
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #sidebar { position: absolute; height: 100%; z-index: 50; transform: translateX(-100%); background: var(--c-panel);}
            #sidebar.mobile-active { transform: translateX(0); }
            #mobile-menu-btn { display: block !important; }
            #zen-toggle { display: none !important; }
        }
        #mobile-menu-btn { display: none; position: absolute; top: 10px; left: 10px; z-index: 60; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header>
        <button class="btn btn-icon" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        <div class="logo"><i class="fas fa-graduation-cap"></i> THESIS.WEB <span style="font-size:10px; font-weight:normal; margin-left:5px; background:#000; color:#fff; padding:2px 4px;">PRO</span></div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-sm" id="btn-guide" title="Open Guide"><i class="fas fa-book"></i> Guide</button>
            <button class="btn btn-sm" id="btn-ref" title="Insert Reference"><i class="fas fa-book-open"></i> Refs</button>
            <button class="btn btn-sm btn-primary" id="btn-save"><i class="fas fa-save"></i> Save</button>
            <button class="btn btn-sm" id="btn-print"><i class="fas fa-print"></i> PDF</button>
            <button class="btn btn-sm" id="btn-zen" title="Focus Mode"><i class="fas fa-expand"></i></button>
        </div>
    </header>

    <div id="app-container">
        
        <!-- SIDEBAR -->
        <aside class="panel" id="sidebar">
            <!-- Standard Selection -->
            <div class="sidebar-section">
                <span class="sidebar-title">1. Standard</span>
                <button class="format-option active" data-style="style-abnt" onclick="App.setStandard('abnt')">
                    <i class="fas fa-flag"></i> ABNT (NBR 14724)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Arial 12pt, 1.5</div>
                </button>
                <button class="format-option" data-style="style-apa" onclick="App.setStandard('apa')">
                    <i class="fas fa-landmark"></i> APA (7th Ed)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Times, Double</div>
                </button>
                <button class="format-option" data-style="style-mla" onclick="App.setStandard('mla')">
                    <i class="fas fa-university"></i> MLA (9th Ed)
                    <div style="font-size:10px; font-weight:normal; margin-left:auto;">Times, Single</div>
                </button>
            </div>

            <!-- Formatting Tools -->
            <div class="sidebar-section">
                <span class="sidebar-title">2. Text Format</span>
                <div class="toolbar-grid">
                    <button class="btn btn-sm" onclick="App.exec('bold')"><b>B</b></button>
                    <button class="btn btn-sm" onclick="App.exec('italic')"><i>I</i></button>
                    <button class="btn btn-sm" onclick="App.exec('underline')"><u>U</u></button>
                    <button class="btn btn-sm" onclick="App.exec('strikeThrough')"><s>S</s></button>
                </div>
                <div style="height:5px;"></div>
                <div class="toolbar-grid">
                    <button class="btn btn-sm" onclick="App.exec('justifyLeft')"><i class="fas fa-align-left"></i></button>
                    <button class="btn btn-sm" onclick="App.exec('justifyCenter')"><i class="fas fa-align-center"></i></button>
                    <button class="btn btn-sm" onclick="App.exec('justifyRight')"><i class="fas fa-align-right"></i></button>
                    <button class="btn btn-sm" onclick="App.exec('justifyFull')"><i class="fas fa-align-justify"></i></button>
                </div>
                <div style="margin-top:10px;">
                    <button class="btn btn-sm" style="width:100%" onclick="App.exec('insertUnorderedList')"><i class="fas fa-list-ul"></i> Bullet List</button>
                    <button class="btn btn-sm" style="width:100%; margin-top:5px;" onclick="App.exec('insertOrderedList')"><i class="fas fa-list-ol"></i> Numbered List</button>
                </div>
            </div>

            <!-- Page Tools -->
            <div class="sidebar-section">
                <span class="sidebar-title">3. Page Tools</span>
                <button class="btn btn-sm btn-secondary" style="width:100%; margin-bottom:8px;" id="btn-toggle-cover" onclick="App.toggleCover()">
                    <i class="fas fa-file"></i> <span id="cover-btn-text">Insert Cover Page</span>
                </button>
                <small style="display:block; margin-bottom:8px; color:#666;">Auto-formats cover for selected standard.</small>
                <button class="btn btn-sm btn-secondary" style="width:100%; margin-bottom:8px;" onclick="App.insertStructure('abstract')">
                    <i class="fas fa-heading"></i> Insert Abstract
                </button>
                <button class="btn btn-sm btn-secondary" style="width:100%;" onclick="App.insertStructure('references')">
                    <i class="fas fa-book-open"></i> Insert Ref. Header
                </button>
                <button class="btn btn-sm btn-danger" style="width:100%; margin-top:8px;" onclick="App.clearPaper()"><i class="fas fa-trash"></i> Clear Paper</button>
            </div>

            <!-- Checklist -->
            <div class="sidebar-section">
                <span class="sidebar-title">4. Pre-flight Checklist</span>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-1"><span>Margins correct?</span>
                </div>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-2"><span>Font size correct?</span>
                </div>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-3"><span>Refs validated?</span>
                </div>
                <div class="checklist-item" onclick="this.querySelector('input').click()">
                    <input type="checkbox" id="chk-4"><span>Spelling checked?</span>
                </div>
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main id="workspace">
            <div id="paper" class="style-abnt">
                <!-- Cover Page -->
                <div id="cover-page">
                    <h2 contenteditable="true">INSTITUTION NAME</h2>
                    <h3 contenteditable="true">Author Name</h3>
                    <h1 contenteditable="true">Title of the Work</h1>
                    <p style="margin-top:100px; text-indent:0;" contenteditable="true">City</p>
                    <p style="text-indent:0;" contenteditable="true">Year</p>
                </div>

                <!-- Main Text Editor -->
                <div id="editor-area" contenteditable="true" spellcheck="false">
                    <h1>Introduction</h1>
                    <p>Start writing your academic work here. The text will automatically adjust to the selected standard (ABNT, APA, or MLA).</p>
                    <p>Use the sidebar to change formatting. Margins are handled automatically for print/PDF export.</p>
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- FOOTER -->
    <footer>
        <div id="status-std">STD: ABNT (NBR 14724)</div>
        <div id="status-stats">Words: 0 | Chars: 0</div>
        <div id="status-save"><i class="fas fa-check-circle" style="color:var(--c-success)"></i> Saved</div>
    </footer>

    <!-- FOCUS MODE TOGGLE -->
    <button class="btn btn-icon" id="zen-toggle" onclick="App.toggleZen()">
        <i class="fas fa-compress"></i> Exit Focus
    </button>

    <!-- GUIDE MODAL -->
    <div class="modal-overlay hidden" id="guide-modal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-info-circle"></i> How to Use</div>
            <div style="font-size:12px; line-height:1.6; max-height:300px; overflow-y:auto;">
                <b>1. Standard:</b> Choose ABNT, APA, or MLA from the sidebar. This sets fonts, margins, and spacing.
                <br><br>
                <b>2. Writing:</b> Type in the main area. Press <b>Enter</b> for new paragraphs. Use toolbar for formatting.
                <br><br>
                <b>3. References:</b> Click the <b>"Refs"</b> button. Fill in the form to generate a correctly formatted Bibliography entry.
                <br><br>
                <b>4. Export:</b> <b>"Save"</b> downloads an HTML file. <b>"PDF"</b> opens the print dialog.
                <br><br>
                <i style="color:var(--c-danger)">Important for PDF:</i> In the print settings, uncheck "Headers and Footers" to remove the URL and date for a professional look.
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-primary" onclick="App.closeModal('guide-modal')">Got it</button>
            </div>
        </div>
    </div>

    <!-- REFERENCE GENERATOR MODAL -->
    <div class="modal-overlay hidden" id="ref-modal">
        <div class="modal-content">
            <div class="modal-header">Bibliographic Reference</div>
            
            <div class="form-group">
                <label>Standard</label>
                <select id="ref-std" onchange="App.updateRefPreview()">
                    <option value="abnt">ABNT (NBR 14724)</option>
                    <option value="apa">APA (7th Ed.)</option>
                    <option value="mla">MLA (9th Ed.)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Author (Surname, Initial)</label>
                <input type="text" id="ref-author" placeholder="Silva, J." oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="ref-title" placeholder="Book Title" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Subtitle (Optional)</label>
                <input type="text" id="ref-subtitle" placeholder="Subtitle" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Edition (Optional)</label>
                <input type="text" id="ref-edition" placeholder="e.g. 2nd ed." oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" id="ref-city" placeholder="Sao Paulo" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Publisher</label>
                <input type="text" id="ref-pub" placeholder="Editora XYZ" oninput="App.updateRefPreview()">
            </div>
            <div class="form-group">
                <label>Year</label>
                <input type="number" id="ref-year" placeholder="2023" oninput="App.updateRefPreview()">
            </div>

            <!-- Live Preview -->
            <div style="background:#eee; border:1px dashed #000; padding:10px; margin-bottom:10px; font-family:serif; font-size:12px;">
                <label style="font-family:var(--font-ui); font-size:10px; display:block; margin-bottom:4px;">PREVIEW:</label>
                <div id="ref-preview-output">...</div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('ref-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.insertReference()"><i class="fas fa-plus"></i> Insert</button>
            </div>
        </div>
    </div>

    <!-- PRINT INSTRUCTION MODAL -->
    <div class="modal-overlay hidden" id="print-modal">
        <div class="modal-content" style="border-color: var(--c-accent);">
            <div class="modal-header"><i class="fas fa-exclamation-triangle"></i> Before Printing</div>
            <div style="font-size:13px; line-height:1.5;">
                <p>To get a professional PDF without browser headers (URL, date), please follow these steps:</p>
                <ol style="margin-left:20px; margin-top:10px;">
                    <li>In the print dialog, look for <b>"More settings"</b>.</li>
                    <li><b>Uncheck</b> the box that says <b>"Headers and footers"</b>.</li>
                    <li>Ensure <b>Background graphics</b> is checked (if you want colors).</li>
                    <li>Set margins to <b>"Default"</b> or <b>"None"</b> (The editor handles its own margins).</li>
                </ol>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="App.closeModal('print-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.confirmPrint()"><i class="fas fa-print"></i> Open Print Dialog</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast hidden" id="toast-msg">Action Successful</div>

    <script>
        class ThesisApp {
            constructor() {
                this.paper = document.getElementById('paper');
                this.editor = document.getElementById('editor-area');
                this.currentStandard = 'abnt';
                
                setTimeout(() => this.init(), 0);
            }

            init() {
                console.log("System Loaded.");
                this.loadState();
                this.bindEvents();
                this.updateStats();
                Utils.toast('System Ready');
            }

            // --- CORE FUNCTIONALITY ---
            exec(command, value = null) {
                document.execCommand(command, false, value);
                this.editor.focus();
                this.autoSave();
            }

            bindEvents() {
                this.editor.addEventListener('input', () => {
                    this.updateStats();
                    this.autoSave();
                });

                document.getElementById('btn-save').onclick = () => this.downloadHTML();
                document.getElementById('btn-print').onclick = () => {
                    this.openModal('print-modal');
                };
                document.getElementById('btn-ref').onclick = () => this.openRefModal();
                document.getElementById('btn-guide').onclick = () => this.openModal('guide-modal');
                document.getElementById('btn-zen').onclick = () => this.toggleZen();
                
                document.getElementById('mobile-menu-btn').onclick = () => {
                    document.getElementById('sidebar').classList.toggle('mobile-active');
                };
            }

            // --- STANDARDS LOGIC ---
            setStandard(std) {
                this.currentStandard = std;
                
                // UI Updates
                document.querySelectorAll('.format-option').forEach(btn => btn.classList.remove('active'));
                const activeBtn = document.querySelector(`.format-option[data-style="style-${std}"]`);
                if(activeBtn) activeBtn.classList.add('active');

                // Paper Class
                this.paper.className = '';
                this.paper.classList.add(`style-${std}`);

                const names = { 
                    abnt: 'ABNT (NBR 14724)', 
                    apa: 'APA (7th Ed)', 
                    mla: 'MLA (9th Ed)' 
                };
                document.getElementById('status-std').innerText = `STD: ${names[std]}`;

                this.saveState();
                Utils.toast(`Switched to ${names[std]}`);
            }

            // --- COVER PAGE ---
            toggleCover() {
                const cover = document.getElementById('cover-page');
                const btnText = document.getElementById('cover-btn-text');
                const btn = document.getElementById('btn-toggle-cover');
                
                // Check current computed style
                const isHidden = cover.style.display === 'none' || cover.style.display === '';
                
                if (isHidden) {
                    cover.style.display = 'flex';
                    btnText.innerText = 'Remove Cover Page';
                    btn.classList.add('btn-danger');
                } else {
                    cover.style.display = 'none';
                    btnText.innerText = 'Insert Cover Page';
                    btn.classList.remove('btn-danger');
                }
                this.autoSave();
            }

            clearPaper() {
                if(confirm('Are you sure? This cannot be undone.')) {
                    this.editor.innerHTML = '<h1>Start writing...</h1><p>Content cleared.</p>';
                    this.updateStats();
                    this.autoSave();
                }
            }

            // --- REFERENCE GENERATOR ---
            openRefModal() {
                document.getElementById('ref-std').value = this.currentStandard;
                // Clear fields
                document.getElementById('ref-author').value = '';
                document.getElementById('ref-title').value = '';
                document.getElementById('ref-subtitle').value = '';
                document.getElementById('ref-edition').value = '';
                document.getElementById('ref-city').value = '';
                document.getElementById('ref-pub').value = '';
                document.getElementById('ref-year').value = '';
                this.updateRefPreview();
                this.openModal('ref-modal');
            }

            updateRefPreview() {
                const std = document.getElementById('ref-std').value;
                const auth = document.getElementById('ref-author').value || 'AUTHOR';
                const title = document.getElementById('ref-title').value || 'TITLE';
                const sub = document.getElementById('ref-subtitle').value;
                const edition = document.getElementById('ref-edition').value;
                const city = document.getElementById('ref-city').value || 'CITY';
                const pub = document.getElementById('ref-pub').value || 'PUBLISHER';
                const year = document.getElementById('ref-year').value || 'YEAR';

                let html = '';

                if (std === 'abnt') {
                    // ABNT: AUTHOR. <b>Title</b>: subtitle. Edition. City: Publisher, Year.
                    html = `${auth}. <b>${title}</b>${sub ? ': ' + sub : ''}${edition ? '. ' + edition : ''}. ${city}: ${pub}, ${year}.`;
                } else if (std === 'apa') {
                    // APA: Author. (Year). <i>Title</i>. Publisher.
                    html = `${auth}. (${year}). <i>${title}</i>. ${pub}.`;
                } else {
                    // MLA: Author. <i>Title</i>. Publisher, Year.
                    html = `${auth}. <i>${title}</i>. ${pub}, ${year}.`;
                }

                document.getElementById('ref-preview-output').innerHTML = html;
            }

            insertReference() {
                // Clone the preview html
                const html = document.getElementById('ref-preview-output').innerHTML;
                
                // Create a paragraph
                const p = document.createElement('p');
                p.innerHTML = html;
                
                // Append to editor
                this.editor.appendChild(p);
                
                // Scroll to bottom
                this.editor.scrollTop = this.editor.scrollHeight;
                
                this.closeModal('ref-modal');
                this.autoSave();
                Utils.toast('Reference Added');
            }

            // --- PRINT WORKFLOW ---
            confirmPrint() {
                this.closeModal('print-modal');
                setTimeout(() => {
                    window.print();
                }, 300);
            }

            // --- STRUCTURE HELPERS ---
            insertStructure(type) {
                if(type === 'abstract') {
                    const h2 = document.createElement('h2');
                    const label = (this.currentStandard === 'abnt') ? 'RESUMO' : 'ABSTRACT';
                    h2.innerText = label;
                    
                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    
                    this.editor.insertBefore(h2, this.editor.firstChild);
                    this.editor.insertBefore(p, this.editor.children[1]);
                    this.autoSave();
                } else if (type === 'references') {
                    const h2 = document.createElement('h2');
                    const label = (this.currentStandard === 'abnt') ? 'REFERÃŠNCIAS' : 'REFERENCES';
                    h2.innerText = label;

                    const p = document.createElement('p');
                    p.innerHTML = '<br>';
                    
                    this.editor.appendChild(h2);
                    this.editor.appendChild(p);
                    this.autoSave();
                }
            }

            // --- EXPORT HTML ---
            downloadHTML() {
                const stdName = this.currentStandard.toUpperCase();
                const date = new Date().toISOString().slice(0,10);
                const content = this.paper.outerHTML;
                
                // Inline minimal CSS for the downloaded file to look good locally
                let css = '';
                if (this.currentStandard === 'abnt') {
                    css = `body { font-family: Arial, sans-serif; padding: 3cm 2cm 2cm 3cm; }
                           h1 { font-size: 14pt; font-weight: bold; text-align: center; }
                           p { font-size: 12pt; line-height: 1.5; text-align: justify; text-indent: 1.25cm; margin: 0; }`;
                } else if (this.currentStandard === 'apa') {
                    css = `body { font-family: 'Times New Roman', serif; padding: 1in; }
                           h1 { font-size: 12pt; font-weight: bold; text-align: center; }
                           p { font-size: 12pt; line-height: 2; text-align: left; margin: 0 0 10px 0; text-indent: 0.5in; }
                           p:first-of-type { text-indent: 0; }`;
                } else {
                    css = `body { font-family: 'Times New Roman', serif; padding: 1in; }
                           h1 { font-size: 14pt; font-weight: bold; }
                           p { font-size: 12pt; line-height: 1; text-align: left; margin: 0 0 10px 0; }`;
                }

                const htmlFull = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Thesis_${date}_${stdName}</title>
    <style>
        ${css}
    </style>
</head>
<body>
    ${content}
</body>
</html>
                `;
                
                const blob = new Blob([htmlFull], {type: 'text/html'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Thesis_${date}_${stdName.toLowerCase()}.html`;
                a.click();
                Utils.toast('HTML File Downloaded');
            }

            // --- UTILITIES ---
            updateStats() {
                const text = this.editor.innerText || '';
                const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
                const chars = text.length;
                document.getElementById('status-stats').innerText = `Words: ${words} | Chars: ${chars}`;
            }

            autoSave() {
                // Save paper state
                const content = this.paper.outerHTML;
                localStorage.setItem('thesis-content', content);
                localStorage.setItem('thesis-std', this.currentStandard);
                
                const status = document.getElementById('status-save');
                status.innerHTML = '<i class="fas fa-pen"></i> Saving...';
                setTimeout(() => {
                    status.innerHTML = '<i class="fas fa-check-circle" style="color:var(--c-success)"></i> Saved';
                }, 500);
            }

            loadState() {
                const saved = localStorage.getItem('thesis-content');
                const savedStd = localStorage.getItem('thesis-std');
                
                if(saved) {
                    // Replace paper content entirely
                    // We use a temporary div to parse the HTML safely
                    const temp = document.createElement('div');
                    temp.innerHTML = saved;
                    const newPaper = temp.firstElementChild;
                    
                    // Preserve ID
                    newPaper.id = 'paper';
                    this.paper.parentNode.replaceChild(newPaper, this.paper);
                    this.paper = newPaper; // update reference
                    this.editor = document.getElementById('editor-area'); // update editor reference
                }
                
                if(savedStd) {
                    this.setStandard(savedStd);
                } else {
                    this.setStandard('abnt');
                }
                
                this.updateStats();
            }

            // --- MODAL SYSTEM ---
            openModal(id) {
                const modal = document.getElementById(id);
                if(modal) modal.classList.remove('hidden');
            }

            closeModal(id) {
                const modal = document.getElementById(id);
                if(modal) modal.classList.add('hidden');
            }

            toggleZen() {
                document.body.classList.toggle('focus-mode');
            }
        }

        // Utility wrapper
        const Utils = {
            toast: (msg) => {
                const t = document.getElementById('toast-msg');
                t.innerText = msg;
                t.classList.remove('hidden');
                setTimeout(() => t.classList.add('hidden'), 3000);
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            window.App = new ThesisApp();
        });
    </script>
</body>
</html>
