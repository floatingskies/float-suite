<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Paint.web: Paint.net of Web</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FFDE59">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Paint.Web">
    <meta name="description" content="A Scribble and the Paint of Web">
    <meta name="author" content="Front-End Engineer AI">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Manifest Placeholder -->
    <link rel="manifest" id="manifest-placeholder">

    <style>
        /* 
         * ==========================================
         *  THEME VARIABLES & RESET
         * ==========================================
         */
        :root {
            /* Neo-Brutalist Palette */
            --c-bg: #e0e0e0;
            --c-surface: #ffffff;
            --c-text: #000000;
            --c-border: #000000;
            
            --c-primary: #FFDE59;   /* Acid Yellow */
            --c-secondary: #FF90E8; /* Hot Pink */
            --c-tertiary: #23C9FF;  /* Cyan */
            --c-danger: #FF4D4D;    /* Red */
            --c-success: #00E096;   /* Green */
            
            /* Structural */
            --border-width: 3px;
            --shadow-offset: 5px;
            --shadow-hard: 4px 4px 0px var(--c-border);
            --shadow-soft: 0 4px 6px rgba(0,0,0,0.1);
            
            --font-ui: 'Courier New', Courier, monospace; 
            --font-body: 'Roboto Mono', monospace; 
            --sidebar-w: 260px;
            --header-h: 50px;
            --toolbar-h: 60px;
        }

        /* Dark Mode Override */
        [data-theme="dark"] {
            --c-bg: #121212;
            --c-surface: #1e1e1e;
            --c-text: #ffffff;
            --c-border: #ffffff;
            /* Keep brand colors mostly same but slightly desaturated or as accents */
            --c-primary: #cca000; 
            --c-secondary: #d65db1;
            --c-tertiary: #1a8cb8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-ui);
            font-size: 14px;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ==========================================
         *  UTILITIES & COMPONENTS
         * ==========================================
         */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .space-between { justify-content: space-between; }
        .gap-5 { gap: 5px; }
        .gap-10 { gap: 10px; }

        /* Neo-Brutalist Button */
        .btn {
            background: var(--c-surface);
            border: var(--border-width) solid var(--c-border);
            padding: 6px 12px;
            font-family: var(--font-ui);
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 3px 3px 0px var(--c-border);
            transition: all 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            position: relative;
        }

        .btn:hover { transform: translate(-1px, -1px); box-shadow: 4px 4px 0px var(--c-border); }
        .btn:active, .btn.active { transform: translate(3px, 3px); box-shadow: 0px 0px 0px var(--c-border); }
        
        .btn-primary { background: var(--c-primary); }
        .btn-secondary { background: var(--c-secondary); color: #000; }
        .btn-tertiary { background: var(--c-tertiary); color: #000; }
        .btn-danger { background: var(--c-danger); color: #fff; }
        .btn-icon { width: 36px; height: 36px; padding: 0; font-size: 16px; }

        /* Inputs */
        input[type="text"], input[type="number"] {
            background: var(--c-surface);
            border: 2px solid var(--c-border);
            padding: 8px;
            font-family: var(--font-ui);
            font-weight: bold;
            color: var(--c-text);
        }
        input[type="range"] { accent-color: var(--c-border); }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--c-border); border: 2px solid var(--c-surface); }

        /* ==========================================
         *  LAYOUT GRID
         * ==========================================
         */
        #app-container {
            display: flex;
            height: calc(100vh - var(--header-h));
            width: 100%;
            position: relative;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-w);
            background: var(--c-surface);
            border-right: var(--border-width) solid var(--c-border);
            display: flex;
            flex-direction: column;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .sidebar-header {
            padding: 15px;
            background: var(--c-primary);
            border-bottom: var(--border-width) solid var(--c-border);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .note-card {
            background: var(--c-bg);
            border: 2px solid var(--c-border);
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .note-card:hover { transform: translate(-2px, -2px); box-shadow: 3px 3px 0px var(--c-border); }
        .note-card.active { background: var(--c-tertiary); border-color: var(--c-border); box-shadow: 3px 3px 0px var(--c-border); }
        
        .note-title { font-weight: 800; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-meta { font-size: 10px; opacity: 0.8; display: flex; justify-content: space-between; }

        .sidebar-footer {
            padding: 10px;
            border-top: var(--border-width) solid var(--c-border);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* MAIN WORKSPACE */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--c-bg);
            position: relative;
            overflow: hidden;
        }

        /* Toolbar Area */
        .toolbar-container {
            background: var(--c-surface);
            border-bottom: var(--border-width) solid var(--c-border);
            padding: 5px 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 40;
            box-shadow: 0 4px 0px rgba(0,0,0,0.05);
        }

        .tool-row {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 2px;
        }
        
        .separator { width: 2px; height: 24px; background: var(--c-border); flex-shrink: 0; }

        /* Mode Toggle Switch */
        .mode-switch {
            display: flex;
            border: 2px solid var(--c-border);
            background: var(--c-bg);
            font-weight: bold;
        }
        .mode-opt {
            padding: 8px 16px;
            cursor: pointer;
            transition: 0.2s;
            flex: 1;
            text-align: center;
        }
        .mode-opt.active { background: var(--c-secondary); box-shadow: inset 2px 2px 0px var(--c-border); }

        /* Color Picker */
        .color-grid { display: flex; gap: 4px; align-items: center; }
        .color-swatch {
            width: 24px; height: 24px;
            border: 2px solid var(--c-border);
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.1s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-width: 3px; box-shadow: 2px 2px 0px var(--c-border); z-index: 1; }

        /* THE STAGE (Editor + Canvas) */
        .stage-viewport {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            padding: 40px;
            background-color: var(--c-bg);
            /* Dot pattern background */
            background-image: radial-gradient(var(--c-border) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.9;
        }

        .paper-sheet {
            width: 100%;
            max-width: 800px;
            min-height: 1000px;
            background: #fff;
            border: var(--border-width) solid var(--c-border);
            box-shadow: 8px 8px 0px var(--c-border);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Title Input on Paper */
        .paper-title-input {
            width: 100%;
            border: none;
            border-bottom: 2px dashed var(--c-border);
            padding: 20px;
            font-family: var(--font-ui);
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            background: transparent;
        }

        /* Content Area */
        .paper-content {
            flex: 1;
            position: relative;
            /* Grid lines for graph paper feel */
            background-image: linear-gradient(var(--c-border) 1px, transparent 1px),
            linear-gradient(90deg, var(--c-border) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: -1px -1px;
            opacity: 0.1; /* Subtle lines */
        }

        .text-layer {
            position: relative;
            z-index: 10;
            padding: 20px 40px;
            min-height: 800px;
            font-family: var(--font-body);
            font-size: 16px;
            line-height: 1.6;
            color: #000;
            cursor: text;
        }

        .canvas-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none; /* Default: allow text selection */
            touch-action: none;
        }

        /* When in DRAW mode, canvas intercepts clicks */
        .paper-sheet.mode-draw .canvas-layer { pointer-events: auto; cursor: crosshair; }
        .paper-sheet.mode-draw .text-layer { pointer-events: none; } /* Prevent text edits while drawing */

        /* FOOTER STATUS BAR */
        .status-bar {
            height: 30px;
            background: var(--c-surface);
            border-top: var(--border-width) solid var(--c-border);
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            justify-content: space-between;
            font-family: var(--font-ui);
        }

        /* MODALS & TOASTS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .neo-modal {
            background: var(--c-surface);
            border: var(--border-width) solid var(--c-border);
            box-shadow: 10px 10px 0px var(--c-border);
            width: 90%; max-width: 500px;
            padding: 20px;
            position: relative;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { transform: scale(0.8) translateY(20px); } to { transform: scale(1) translateY(0); } }

        .modal-header {
            font-size: 20px; font-weight: 900; margin-bottom: 15px;
            border-bottom: 2px solid var(--c-border); padding-bottom: 10px;
            display: flex; justify-content: space-between;
        }

        .linux-man-content {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border: 2px solid #fff;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .toast-container {
            position: fixed; bottom: 40px; right: 20px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            background: var(--c-primary);
            border: 2px solid var(--c-border);
            padding: 10px 20px;
            box-shadow: 4px 4px 0px var(--c-border);
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
            display: flex; align-items: center; gap: 10px;
        }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute; height: 100%;
                transform: translateX(-100%);
                box-shadow: 5px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay {
                display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 45;
            }
            .sidebar-overlay.active { display: block; }
            .btn-label { display: none; } /* Hide text labels on mobile */
            .btn { padding: 8px; }
            .paper-sheet { min-height: 80vh; }
            .stage-viewport { padding: 10px; }
        }
    </style>
</head>
<body>

    <!-- APP SHELL -->
    <header style="height: var(--header-h); background: var(--c-primary); border-bottom: var(--border-width) solid var(--c-border); display: flex; align-items: center; padding: 0 15px; justify-content: space-between;">
        <div class="flex center gap-10">
            <button class="btn btn-icon" id="menu-toggle" style="background: #fff;"><i class="fas fa-bars"></i></button>
            <div style="font-weight: 900; font-size: 18px; letter-spacing: -1px;">PAINT<span style="color:#000">.WEB</span></div>
        </div>
        <div class="flex gap-5">
            <button class="btn btn-icon" id="theme-btn" title="Toggle Theme"><i class="fas fa-moon"></i></button>
            <button class="btn btn-icon" id="about-btn" title="About"><i class="fas fa-info"></i></button>
        </div>
    </header>

    <div id="app-container">
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span><i class="fas fa-folder-open"></i> Notebook</span>
                <span id="note-count" style="font-size: 10px; background: #000; color: #fff; padding: 2px 6px;">0</span>
            </div>
            <div class="notes-list" id="notes-list">
                <!-- Note Items Injected Here -->
            </div>
            <div class="sidebar-footer">
                <button class="btn btn-primary" id="btn-new" style="grid-column: span 2;"><i class="fas fa-plus"></i> New Note</button>
                <button class="btn btn-secondary" id="btn-import" title="Import JSON"><i class="fas fa-upload"></i> <span class="btn-label">Import</span></button>
                <button class="btn btn-tertiary" id="btn-export" title="Export JSON"><i class="fas fa-download"></i> <span class="btn-label">Export</span></button>
                <input type="file" id="file-input" accept=".json" class="hidden">
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main class="workspace">
            
            <!-- TOOLBARS -->
            <div class="toolbar-container">
                <!-- Mode Switcher -->
                <div class="mode-switch">
                    <div class="mode-opt active" data-mode="text" id="mode-text">
                        <i class="fas fa-pen-nib"></i> TEXT MODE
                    </div>
                    <div class="mode-opt" data-mode="draw" id="mode-draw">
                        <i class="fas fa-paint-brush"></i> PAINT MODE
                    </div>
                </div>

                <!-- Row 1: General Actions & History -->
                <div class="tool-row">
                    <button class="btn btn-icon" id="btn-undo" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                    <button class="btn btn-icon" id="btn-redo" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                    <div class="separator"></div>
                    <button class="btn btn-icon" id="btn-clear" title="Clear Canvas"><i class="fas fa-trash-alt"></i></button>
                    <button class="btn btn-icon btn-danger" id="btn-delete-note" title="Delete Note"><i class="fas fa-file-excel"></i></button>
                    <div style="flex:1"></div>
                    <button class="btn btn-primary" id="btn-save"><i class="fas fa-save"></i> Save Now</button>
                </div>

                <!-- Row 2: Drawing Tools (Only visible/active in Paint Mode logic, but always visible for UI flow) -->
                <div class="tool-row" id="drawing-tools">
                    <button class="btn btn-icon active" data-tool="pen" title="Freehand Pen"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn btn-icon" data-tool="line" title="Line"><i class="fas fa-slash"></i></button>
                    <button class="btn btn-icon" data-tool="rect" title="Rectangle"><i class="far fa-square"></i></button>
                    <button class="btn btn-icon" data-tool="circle" title="Circle"><i class="far fa-circle"></i></button>
                    <div class="separator"></div>
                    <button class="btn btn-icon" data-tool="eraser" title="Eraser"><i class="fas fa-eraser"></i></button>
                    <div class="separator"></div>
                    
                    <!-- Colors -->
                    <div class="color-grid">
                        <div class="color-swatch active" style="background: #000;" data-color="#000000"></div>
                        <div class="color-swatch" style="background: #FF4D4D;" data-color="#FF4D4D"></div>
                        <div class="color-swatch" style="background: #23C9FF;" data-color="#23C9FF"></div>
                        <div class="color-swatch" style="background: #00E096;" data-color="#00E096"></div>
                        <div class="color-swatch" style="background: #FF90E8;" data-color="#FF90E8"></div>
                    </div>
                    
                    <div class="separator"></div>
                    <div style="display: flex; align-items: center; gap: 5px; font-size: 10px; font-weight: bold;">
                        SIZE
                        <input type="range" id="line-width" min="1" max="20" value="3" style="width: 60px;">
                    </div>
                </div>
            </div>

            <!-- CANVAS STAGE -->
            <div class="stage-viewport" id="stage-viewport">
                <div class="paper-sheet" id="paper-sheet">
                    <input type="text" class="paper-title-input" id="note-title" placeholder="UNTITLED NOTE">
                    
                    <div class="paper-content">
                        <!-- HTML5 Text Editor -->
                        <div class="text-layer" id="text-editor" contenteditable="true">
                            <p>Start typing here...</p>
                        </div>
                        <!-- Drawing Layer -->
                        <canvas id="drawing-canvas" class="canvas-layer"></canvas>
                    </div>
                </div>
            </div>

            <!-- STATUS BAR -->
            <div class="status-bar">
                <div id="status-coords">X: 0 Y: 0</div>
                <div id="status-msg">Ready</div>
                <div id="status-mode">MODE: TEXT</div>
            </div>
        </main>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toast-container"></div>

    <!-- ABOUT MODAL (Linux Man Style) -->
    <div class="modal-overlay hidden" id="about-modal">
        <div class="neo-modal">
            <div class="modal-header">
                <span> Paint(1) </span>
                <button class="btn btn-icon" id="close-about"><i class="fas fa-times"></i></button>
            </div>
            <div class="linux-man-content">
Paint.web(1)              General Commands Manual             Paint.web(1)

NAME
     Paint.web - The paint.net of the web

SYNOPSIS
     A single-file HTML5 application for creative note-taking and 
     raster graphics editing.

DESCRIPTION
     Paint.web combines a rich text editor with a raster graphics 
     engine (canvas) reminiscent of Paint.net.

FEATURES
     - Layered Architecture (Text background, Drawing foreground)
     - Vector-like Shape Previews (Rect, Circle, Line)
     - Infinite Undo/Redo History
     - JSON Import/Export (Portable Data)
     - Dark Mode Support
     - PWA Ready

TOOLS
     Pen       Freehand drawing
     Line      Straight lines
     Rect      Hollow rectangles
     Circle    Hollow circles
     Eraser    Removal of pixels

AUTHOR
     Created by AI Agent.
     Version 2.0.0 (Stable)

REPORTING BUGS
     No support channel. You are on your own.
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <button class="btn btn-primary" id="btn-ok-man">q (quit)</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRM MODAL -->
    <div class="modal-overlay hidden" id="delete-modal">
        <div class="neo-modal" style="border-color: var(--c-danger);">
            <div class="modal-header" style="color: var(--c-danger);">
                <span>DELETE NOTE?</span>
            </div>
            <p style="margin-bottom: 20px;">Are you sure? This action writes zeros to the storage sector.</p>
            <div class="flex gap-10" style="justify-content: flex-end;">
                <button class="btn" id="cancel-del">Cancel</button>
                <button class="btn btn-danger" id="confirm-del">Execute Delete</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * PAINT.WEB WEB ENGINE
         * Single File Architecture
         * 
         * Modules:
         * 1. ToastSystem
         * 2. StorageManager
         * 3. HistoryManager
         * 4. PaintEngine
         * 5. AppController
         */

        // --- 1. TOAST SYSTEM ---
        const Toast = {
            container: document.getElementById('toast-container'),
            show(message, type = 'info') {
                const el = document.createElement('div');
                el.className = 'toast';
                let icon = 'info-circle';
                if(type === 'success') icon = 'check-circle';
                if(type === 'error') icon = 'exclamation-triangle';
                
                el.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;
                
                if(type === 'error') el.style.background = 'var(--c-danger)';
                if(type === 'success') el.style.background = 'var(--c-success)';

                this.container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(20px)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            }
        };

        // --- 2. STORAGE MANAGER ---
        const Storage = {
            KEY: 'paint_web_data_v2',
            save(data) {
                try {
                    localStorage.setItem(this.KEY, JSON.stringify(data));
                    return true;
                } catch (e) {
                    Toast.show('Storage Quota Exceeded!', 'error');
                    return false;
                }
            },
            load() {
                const raw = localStorage.getItem(this.KEY);
                return raw ? JSON.parse(raw) : null;
            },
            exportJSON(data) {
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `paint_backup_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                Toast.show('Backup Downloaded', 'success');
            }
        };

        // --- 3. HISTORY MANAGER (UNDO/REDO) ---
        class HistoryManager {
            constructor(maxSteps = 20) {
                this.undoStack = [];
                this.redoStack = [];
                this.maxSteps = maxSteps;
                this.state = { text: '', drawing: null };
            }

            save(text, canvas) {
                // Push current state to undo
                this.undoStack.push({ text: text, drawing: canvas.toDataURL() });
                if (this.undoStack.length > this.maxSteps) this.undoStack.shift();
                
                // Clear redo
                this.redoStack = [];
                this.updateUI();
            }

            undo(currentText, currentCanvas) {
                if (this.undoStack.length === 0) return null;
                
                // Save current to redo
                this.redoStack.push({ text: currentText, drawing: currentCanvas.toDataURL() });
                
                // Pop from undo
                const prev = this.undoStack.pop();
                this.updateUI();
                return prev;
            }

            redo(currentText, currentCanvas) {
                if (this.redoStack.length === 0) return null;
                
                // Save current to undo
                this.undoStack.push({ text: currentText, drawing: currentCanvas.toDataURL() });
                
                // Pop from redo
                const next = this.redoStack.pop();
                this.updateUI();
                return next;
            }

            updateUI() {
                document.getElementById('btn-undo').style.opacity = this.undoStack.length > 0 ? '1' : '0.5';
                document.getElementById('btn-redo').style.opacity = this.redoStack.length > 0 ? '1' : '0.5';
            }
        }

        // --- 4. PAINT ENGINE ---
        class PaintEngine {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.isDrawing = false;
                this.tool = 'pen';
                this.color = '#000000';
                this.lineWidth = 3;
                this.startPos = { x: 0, y: 0 };
                this.snapshot = null;

                // Event Binding
                this.bindEvents();
            }

            resize(width, height) {
                // Save content before resize
                let saved = null;
                if (this.canvas.width > 0) saved = this.canvas.toDataURL();

                this.canvas.width = width;
                this.canvas.height = height;

                if (saved) {
                    const img = new Image();
                    img.onload = () => this.ctx.drawImage(img, 0, 0);
                    img.src = saved;
                }
            }

            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            loadData(dataUrl) {
                const img = new Image();
                img.onload = () => this.ctx.drawImage(img, 0, 0);
                img.src = dataUrl;
            }

            bindEvents() {
                const start = (e) => {
                    if(e.target !== this.canvas) return;
                    e.preventDefault();
                    this.isDrawing = true;
                    const pos = this.getPos(e);
                    this.startPos = pos;
                    
                    // Config context
                    this.ctx.lineWidth = this.lineWidth;
                    this.ctx.lineCap = 'square'; // Neo-brutalist hard edges
                    this.ctx.strokeStyle = this.tool === 'eraser' ? '#ffffff' : this.color;
                    
                    if (this.tool === 'eraser') {
                        this.ctx.globalCompositeOperation = 'destination-out';
                    } else {
                        this.ctx.globalCompositeOperation = 'source-over';
                    }

                    this.ctx.beginPath();
                    this.ctx.moveTo(pos.x, pos.y);
                    
                    // Save snapshot for shape preview
                    this.snapshot = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                };

                const move = (e) => {
                    if (!this.isDrawing) return;
                    e.preventDefault();
                    const pos = this.getPos(e);

                    // Restore logic for shapes (Rect, Circle, Line)
                    if (['rect', 'circle', 'line'].includes(this.tool)) {
                        this.ctx.putImageData(this.snapshot, 0, 0);
                    }

                    if (this.tool === 'pen' || this.tool === 'eraser') {
                        this.ctx.lineTo(pos.x, pos.y);
                        this.ctx.stroke();
                    } else if (this.tool === 'line') {
                        this.ctx.beginPath();
                        this.ctx.moveTo(this.startPos.x, this.startPos.y);
                        this.ctx.lineTo(pos.x, pos.y);
                        this.ctx.stroke();
                    } else if (this.tool === 'rect') {
                        this.ctx.strokeRect(this.startPos.x, this.startPos.y, pos.x - this.startPos.x, pos.y - this.startPos.y);
                    } else if (this.tool === 'circle') {
                        const radius = Math.sqrt(Math.pow(pos.x - this.startPos.x, 2) + Math.pow(pos.y - this.startPos.y, 2));
                        this.ctx.beginPath();
                        this.ctx.arc(this.startPos.x, this.startPos.y, radius, 0, 2 * Math.PI);
                        this.ctx.stroke();
                    }

                    // Update UI
                    document.getElementById('status-coords').innerText = `X: ${Math.round(pos.x)} Y: ${Math.round(pos.y)}`;
                };

                const end = () => {
                    if (!this.isDrawing) return;
                    this.isDrawing = false;
                    this.ctx.closePath();
                    this.ctx.globalCompositeOperation = 'source-over'; // Reset
                    App.saveHistory(); // Trigger save to history stack
                    App.autoSave(); // Trigger auto-save to storage
                };

                this.canvas.addEventListener('mousedown', start);
                this.canvas.addEventListener('mousemove', move);
                this.canvas.addEventListener('mouseup', end);
                this.canvas.addEventListener('mouseout', end);
                
                this.canvas.addEventListener('touchstart', start, {passive: false});
                this.canvas.addEventListener('touchmove', move, {passive: false});
                this.canvas.addEventListener('touchend', end);
            }

            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }
        }

        // --- 5. APP CONTROLLER ---
        const App = {
            data: [],
            currentNoteId: null,
            mode: 'text', // 'text' or 'draw'
            history: new HistoryManager(),
            paint: null,
            
            // UI Elements
            ui: {
                notesList: document.getElementById('notes-list'),
                title: document.getElementById('note-title'),
                editor: document.getElementById('text-editor'),
                paperSheet: document.getElementById('paper-sheet'),
                modeOpts: document.querySelectorAll('.mode-opt'),
                tools: document.querySelectorAll('#drawing-tools .btn'),
                colors: document.querySelectorAll('.color-swatch'),
                lineWidth: document.getElementById('line-width'),
                stage: document.getElementById('stage-viewport')
            },

            init() {
                // Init PWA Manifest
                const manifest = {
                    name: "Paint.web",
                    short_name: "Paint.web",
                    start_url: ".", display: "standalone",
                    background_color: "#e0e0e0", theme_color: "#FFDE59",
                    icons: [{ src: "https://cdn-icons-png.flaticon.com/512/616/616490.png", sizes: "192x192", type: "image/png" }]
                };
                document.getElementById('manifest-placeholder').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));

                // Init Paint Engine
                this.paint = new PaintEngine('drawing-canvas');
                
                // Initial Resize
                window.addEventListener('resize', () => this.handleResize());
                setTimeout(() => this.handleResize(), 100);

                // Load Data
                const stored = Storage.load();
                if (stored && stored.length) {
                    this.data = stored;
                    this.loadNote(this.data[0].id);
                } else {
                    this.createNote();
                }
                this.renderList();

                // Bind Events
                this.bindGlobalEvents();
                this.bindToolbarEvents();

                // Theme
                if(localStorage.getItem('clownfish-theme') === 'dark') {
                    document.body.setAttribute('data-theme', 'dark');
                    document.getElementById('theme-btn').innerHTML = '<i class="fas fa-sun"></i>';
                }
            },

            handleResize() {
                const rect = this.ui.paperSheet.querySelector('.paper-content').getBoundingClientRect();
                // Only resize if dimensions changed significantly to avoid clearing canvas unnecessarily
                if (this.paint.canvas.width !== rect.width || this.paint.canvas.height !== rect.height) {
                    this.paint.resize(rect.width, rect.height);
                }
            },

            createNote() {
                const newNote = {
                    id: Date.now().toString(),
                    title: 'UNTITLED NOTE',
                    content: '<p>Start typing...</p>',
                    drawing: null,
                    updated: Date.now()
                };
                this.data.unshift(newNote);
                this.loadNote(newNote.id);
                this.renderList();
                this.saveStorage();
                Toast.show('New Note Created');
            },

            loadNote(id) {
                this.currentNoteId = id;
                const note = this.data.find(n => n.id === id);
                if(!note) return;

                this.ui.title.value = note.title;
                this.ui.editor.innerHTML = note.content;
                
                if (note.drawing) {
                    this.paint.loadData(note.drawing);
                } else {
                    this.paint.clear();
                }

                // Reset history
                this.history = new HistoryManager();
                this.history.save(note.content, this.paint.canvas);

                this.renderList();
                this.updateStatus('Loaded: ' + note.title);
            },

            saveHistory() {
                this.history.save(this.ui.editor.innerHTML, this.paint.canvas);
            },

            updateCurrentNote() {
                const note = this.data.find(n => n.id === this.currentNoteId);
                if(!note) return;
                
                note.title = this.ui.title.value || 'UNTITLED';
                note.content = this.ui.editor.innerHTML;
                note.drawing = this.paint.canvas.toDataURL();
                note.updated = Date.now();
                
                this.saveStorage();
                this.renderList();
                this.updateStatus('Auto-saved');
            },

            saveStorage() {
                Storage.save(this.data);
            },

            autoSave() {
                // Debounce could be added here, but for simplicity we call directly
                this.updateCurrentNote();
            },

            deleteNote() {
                if(!this.currentNoteId) return;
                this.data = this.data.filter(n => n.id !== this.currentNoteId);
                this.saveStorage();
                
                if (this.data.length > 0) {
                    this.loadNote(this.data[0].id);
                } else {
                    this.createNote();
                }
                document.getElementById('delete-modal').classList.add('hidden');
            },

            renderList() {
                this.ui.notesList.innerHTML = '';
                this.data.forEach(note => {
                    const div = document.createElement('div');
                    div.className = `note-card ${note.id === this.currentNoteId ? 'active' : ''}`;
                    div.onclick = () => {
                        this.loadNote(note.id);
                        // Mobile sidebar close
                        document.getElementById('sidebar').classList.remove('open');
                        document.getElementById('sidebar-overlay').classList.remove('active');
                    };
                    div.innerHTML = `
                        <div class="note-title">${note.title}</div>
                        <div class="note-meta">
                            <span>${new Date(note.updated).toLocaleDateString()}</span>
                            <span><i class="fas fa-image"></i> ${note.drawing ? 'Yes' : 'No'}</span>
                        </div>
                    `;
                    this.ui.notesList.appendChild(div);
                });
                document.getElementById('note-count').innerText = this.data.length;
            },

            setMode(mode) {
                this.mode = mode;
                this.ui.modeOpts.forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.mode === mode);
                });
                this.ui.paperSheet.className = `paper-sheet mode-${mode}`;
                document.getElementById('status-mode').innerText = `MODE: ${mode.toUpperCase()}`;
                
                // Visibility of Drawing Tools
                const toolRow = document.getElementById('drawing-tools');
                if(mode === 'draw') {
                    toolRow.style.opacity = '1';
                    toolRow.style.pointerEvents = 'auto';
                } else {
                    toolRow.style.opacity = '0.5';
                    toolRow.style.pointerEvents = 'none';
                }
            },

            updateStatus(msg) {
                document.getElementById('status-msg').innerText = msg;
            },

            bindGlobalEvents() {
                // Sidebar Toggles
                const toggleSidebar = () => {
                    const sb = document.getElementById('sidebar');
                    const ov = document.getElementById('sidebar-overlay');
                    sb.classList.toggle('open');
                    ov.classList.toggle('active');
                };
                document.getElementById('menu-toggle').onclick = toggleSidebar;
                document.getElementById('sidebar-overlay').onclick = toggleSidebar;

                // New Note
                document.getElementById('btn-new').onclick = () => this.createNote();

                // Save Button
                document.getElementById('btn-save').onclick = () => {
                    this.updateCurrentNote();
                    Toast.show('Note Saved Successfully', 'success');
                };

                // Theme
                document.getElementById('theme-btn').onclick = () => {
                    const body = document.body;
                    if (body.hasAttribute('data-theme')) {
                        body.removeAttribute('data-theme');
                        localStorage.setItem('clownfish-theme', 'light');
                        document.getElementById('theme-btn').innerHTML = '<i class="fas fa-moon"></i>';
                    } else {
                        body.setAttribute('data-theme', 'dark');
                        localStorage.setItem('clownfish-theme', 'dark');
                        document.getElementById('theme-btn').innerHTML = '<i class="fas fa-sun"></i>';
                    }
                };

                // About Modal
                const aboutModal = document.getElementById('about-modal');
                document.getElementById('about-btn').onclick = () => aboutModal.classList.remove('hidden');
                document.getElementById('close-about').onclick = () => aboutModal.classList.add('hidden');
                document.getElementById('btn-ok-man').onclick = () => aboutModal.classList.add('hidden');

                // Delete Modal
                const delModal = document.getElementById('delete-modal');
                document.getElementById('btn-delete-note').onclick = () => delModal.classList.remove('hidden');
                document.getElementById('cancel-del').onclick = () => delModal.classList.add('hidden');
                document.getElementById('confirm-del').onclick = () => this.deleteNote();

                // Import / Export
                document.getElementById('btn-export').onclick = () => Storage.exportJSON(this.data);
                document.getElementById('btn-import').onclick = () => document.getElementById('file-input').click();
                document.getElementById('file-input').onchange = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            this.data = JSON.parse(ev.target.result);
                            this.saveStorage();
                            this.loadNote(this.data[0].id);
                            this.renderList();
                            Toast.show('Import Successful', 'success');
                        } catch (err) {
                            Toast.show('Invalid JSON File', 'error');
                        }
                    };
                    reader.readAsText(file);
                };

                // History Buttons
                document.getElementById('btn-undo').onclick = () => this.performUndo();
                document.getElementById('btn-redo').onclick = () => this.performRedo();
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        this.performUndo();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                        e.preventDefault();
                        this.performRedo();
                    }
                });

                // Auto-save on text input (debounced slightly by browser)
                this.ui.editor.addEventListener('input', () => {
                    this.autoSave(); // In a real app, debounce this
                });
                this.ui.title.addEventListener('input', () => this.autoSave());

                // Clear Canvas
                document.getElementById('btn-clear').onclick = () => {
                    if(confirm('Clear all drawings?')) {
                        this.paint.clear();
                        this.saveHistory();
                        this.autoSave();
                    }
                };
            },

            bindToolbarEvents() {
                // Mode Switching
                this.ui.modeOpts.forEach(opt => {
                    opt.onclick = () => this.setMode(opt.dataset.mode);
                });

                // Tools
                this.ui.tools.forEach(btn => {
                    btn.onclick = () => {
                        // Remove active class from siblings
                        this.ui.tools.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const toolName = btn.dataset.tool;
                        if(toolName) {
                            this.paint.tool = toolName;
                            this.updateStatus(`Tool: ${toolName.toUpperCase()}`);
                        }
                    };
                });

                // Colors
                this.ui.colors.forEach(swatch => {
                    swatch.onclick = () => {
                        this.ui.colors.forEach(c => c.classList.remove('active'));
                        swatch.classList.add('active');
                        this.paint.color = swatch.dataset.color;
                    };
                });

                // Line Width
                this.ui.lineWidth.oninput = (e) => {
                    this.paint.lineWidth = e.target.value;
                    this.updateStatus(`Size: ${e.target.value}px`);
                };
            },

            performUndo() {
                const state = this.history.undo(this.ui.editor.innerHTML, this.paint.canvas);
                if(state) {
                    this.ui.editor.innerHTML = state.text;
                    this.paint.loadData(state.drawing);
                    Toast.show('Undo');
                }
            },

            performRedo() {
                const state = this.history.redo(this.ui.editor.innerHTML, this.paint.canvas);
                if(state) {
                    this.ui.editor.innerHTML = state.text;
                    this.paint.loadData(state.drawing);
                    Toast.show('Redo');
                }
            }
        };

        // Start Application
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</html>
